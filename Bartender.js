// Strange Flesh Â© 2017 by Greatest Bear Studios
// 
// Strange Flesh is licensed under a
// Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
// 
// You should have received a copy of the license along with this
// work. If not, see <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
//
// This sourcecode has not been minified or obfuscated in any way. Enjoy.
//

GlobalResourceLoader.AddAudioResource("bartender_desperation1","sound/bartender/bartender_desperation1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_desperation2","sound/bartender/bartender_desperation2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_desperation3","sound/bartender/bartender_desperation3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_down1","sound/bartender/bartender_down1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_down2","sound/bartender/bartender_down2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_down3","sound/bartender/bartender_down3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_hit1","sound/bartender/bartender_drunk_hit1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_hit2","sound/bartender/bartender_drunk_hit2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_hit3","sound/bartender/bartender_drunk_hit3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_kick1","sound/bartender/bartender_drunk_kick1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_kick2","sound/bartender/bartender_drunk_kick2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_kick3","sound/bartender/bartender_drunk_kick3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_kiss1","sound/bartender/bartender_drunk_kiss1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_kiss2","sound/bartender/bartender_drunk_kiss2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_kiss3","sound/bartender/bartender_drunk_kiss3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_punch1","sound/bartender/bartender_drunk_punch1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_punch2","sound/bartender/bartender_drunk_punch2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_punch3","sound/bartender/bartender_drunk_punch3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_stumble1","sound/bartender/bartender_drunk_stumble1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_stumble2","sound/bartender/bartender_drunk_stumble2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_tackle1","sound/bartender/bartender_drunk_tackle1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_tackle2","sound/bartender/bartender_drunk_tackle2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunk_tackle3","sound/bartender/bartender_drunk_tackle3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_drunkidle","sound/bartender/bartender_drunkidle.mp3");
GlobalResourceLoader.AddAudioResource("bartender_grab1","sound/bartender/bartender_grab1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_grab2","sound/bartender/bartender_grab2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_grab3","sound/bartender/bartender_grab3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_hit1","sound/bartender/bartender_hit1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_hit2","sound/bartender/bartender_hit2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_hit3","sound/bartender/bartender_hit3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_jump1","sound/bartender/bartender_jump1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_jump2","sound/bartender/bartender_jump2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_jump3","sound/bartender/bartender_jump3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_jumpkick1","sound/bartender/bartender_jumpkick1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_jumpkick2","sound/bartender/bartender_jumpkick2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_jumpkick3","sound/bartender/bartender_jumpkick3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_kick1","sound/bartender/bartender_kick1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_kick2","sound/bartender/bartender_kick2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_kick3","sound/bartender/bartender_kick3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_kick4","sound/bartender/bartender_kick4.mp3");
GlobalResourceLoader.AddAudioResource("bartender_landing","sound/bartender/bartender_landing.mp3");
GlobalResourceLoader.AddAudioResource("bartender_puff1","sound/bartender/bartender_puff1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_puff2","sound/bartender/bartender_puff2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_puff3","sound/bartender/bartender_puff3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_puff4","sound/bartender/bartender_puff4.mp3");
GlobalResourceLoader.AddAudioResource("bartender_puff5","sound/bartender/bartender_puff5.mp3");
GlobalResourceLoader.AddAudioResource("bartender_punch1","sound/bartender/bartender_punch1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_punch2","sound/bartender/bartender_punch2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_punch3","sound/bartender/bartender_punch3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_punch4","sound/bartender/bartender_punch4.mp3");
GlobalResourceLoader.AddAudioResource("bartender_run1","sound/bartender/bartender_run1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_run2","sound/bartender/bartender_run2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_chargequick1","sound/bartender/bartender_smoke_chargequick1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_chargequick2","sound/bartender/bartender_smoke_chargequick2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_chargequick3","sound/bartender/bartender_smoke_chargequick3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_kiss1","sound/bartender/bartender_smoke_kiss1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_kiss2","sound/bartender/bartender_smoke_kiss2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_kiss3","sound/bartender/bartender_smoke_kiss3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_quick1","sound/bartender/bartender_smoke_quick1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_quick2","sound/bartender/bartender_smoke_quick2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smoke_quick3","sound/bartender/bartender_smoke_quick3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_smokering","sound/bartender/bartender_smokering.mp3");
GlobalResourceLoader.AddAudioResource("bartender_spawn","sound/bartender/bartender_spawn.mp3");
GlobalResourceLoader.AddAudioResource("bartender_tackle1","sound/bartender/bartender_tackle1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_tackle2","sound/bartender/bartender_tackle2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_tackle3","sound/bartender/bartender_tackle3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_tackle4","sound/bartender/bartender_tackle4.mp3");
GlobalResourceLoader.AddAudioResource("bartender_throw1","sound/bartender/bartender_throw1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_throw2","sound/bartender/bartender_throw2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_throw3","sound/bartender/bartender_throw3.mp3");
GlobalResourceLoader.AddAudioResource("bartender_walk1","sound/bartender/bartender_walk1.mp3");
GlobalResourceLoader.AddAudioResource("bartender_walk2","sound/bartender/bartender_walk2.mp3");
GlobalResourceLoader.AddAudioResource("bartender_whiff","sound/bartender/bartender_whiff.mp3");
GlobalResourceLoader.AddAudioResource("bartender_forcefulblow","sound/bartender/smoke_blow_long.mp3");

GlobalResourceLoader.AddAudioResource("sex_bootremoval","sound/bartender/sex_bootremoval.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe1","sound/bartender/sex_Joe1.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe1a","sound/bartender/sex_Joe1a.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe1Drunk","sound/bartender/sex_Joe1Drunk.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe2","sound/bartender/sex_Joe2.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe2Drunk","sound/bartender/sex_Joe2Drunk.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe3","sound/bartender/sex_Joe3.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe3Drunk","sound/bartender/sex_Joe3Drunk.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe4","sound/bartender/sex_Joe4.mp3");
GlobalResourceLoader.AddAudioResource("sex_Joe4Drunk","sound/bartender/sex_Joe4Drunk.mp3");
GlobalResourceLoader.AddAudioResource("sex_pantremoval","sound/bartender/sex_pantremoval.mp3");

// Define the sex animation parameters
var thrusts = 8; 
var footjobanimationduration = 6.0; // seconds
var footjobStrokes = 4;
var blowjobanimationduration = 7.0; // seconds
var blowjobStrokes = 6;
var drunkAnalThrusts = 6;
var drunkKisses = 3;
var drunkCowboyThrusts = 6;
var sexanimationduration = 9.0; // seconds
var spitroastanimationduration = 4.0+thrusts*0.8; // seconds

function Bartender()
{
	EntityInit.call(this);

	this.displayName = "The Bartender";
	
	// SFX
	// Idle
	this.puffAndDragSFX = new RandomSoundCollection("bartender_puff{0}",5);
	this.smokeBlowLowSFX = GlobalResourceLoader.GetSound("bartender_smokering");
	
	// Damage taken
	this.hitSFX = new RandomSoundCollection("bartender_hit{0}",3);
	this.hitDrunkSFX = new RandomSoundCollection("bartender_drunk_hit{0}",3);
	this.knockoutSFX = new RandomSoundCollection("bartender_down{0}",3);
	
	// Pickup and throw
	this.grabFailSFX = GlobalResourceLoader.GetSound("bartender_whiff");
	this.heftSFX = new RandomSoundCollection("bartender_grab{0}",3);
	this.throwSFX = new RandomSoundCollection("bartender_throw{0}",3);
	
	// Movement
	this.jumpSFX = new RandomSoundCollection("bartender_jump{0}",3);
	this.landingSFX = GlobalResourceLoader.GetSound("bartender_landing");
	this.footstep_walk1 = GlobalResourceLoader.GetSound("bartender_walk1");
	this.footstep_walk2 = GlobalResourceLoader.GetSound("bartender_walk2");
	this.footstep_run1 = GlobalResourceLoader.GetSound("bartender_run1");
	this.footstep_run2 = GlobalResourceLoader.GetSound("bartender_run2");
	this.drunkStumbleSFX = new RandomSoundCollection("bartender_drunk_stumble{0}", 2);
	
	// Attacks
	this.punchGruntSFX = new RandomSoundCollection("bartender_punch{0}",4);
	this.punchDrunkGruntSFX = new RandomSoundCollection("bartender_drunk_punch{0}",3);
	this.kickGruntSFX = new RandomSoundCollection("bartender_kick{0}",4);
	this.kickDrunkGruntSFX = new RandomSoundCollection("bartender_drunk_kick{0}",3);
	this.tackleGruntSFX = new RandomSoundCollection("bartender_tackle{0}",4);
	this.tackleDrunkGruntSFX = new RandomSoundCollection("bartender_drunk_tackle{0}",3);
	this.quickSmokeSFX = new RandomSoundCollection("bartender_smoke_chargequick{0}",3);
	this.quickSmokeBlowSFX = new RandomSoundCollection("bartender_smoke_quick{0}",3);
	this.desperationSFX = new RandomSoundCollection("bartender_desperation{0}",3);
	this.chargedSmokeSFX = GlobalResourceLoader.GetSound("bartender_forcefulblow");
	
	// Sexier sounds
	this.smokeKissSFX = new RandomSoundCollection("bartender_smoke_kiss{0}",3);
	this.smokeKissDrunkSFX = new RandomSoundCollection("bartender_drunk_kiss{0}",3);
	
	//this.bartenderFootjobSFX = new RandomSoundCollection("bartender_joesex0{0}",3);
	//this.bartenderBlowjobSFX = new RandomSoundCollection("bartender_joesex0{0}",4,6);
	//this.bartenderThrustSFX = new RandomSoundCollection("bartender_joesex0{0}",7,9);
	
	this.sexSFX = null;
	this.sexSFXSource = null;
	this.sexSFXDelay = 0;
	
	// Combat flags
	this.alliance = 1;
	this.grabbable = true;
	this.snareable = true;
	this.fuckable = false;
	this.kissable = false;
	this.throwable = true;
	this.intoxicatable = true;
	
	// Game ending fade out
	this.lightFlash = null;
	this.alphaTimer = 0;
	
	// Stats
	this.walkMaxVel = 9.0;
	this.runMaxVel = 16.0;
	this.maxHitStunFrames = 60;
	this.maxJumpFrames = 6;
	this.maxHealth = 200;
	this.staminaRecoveryPerFrame = 1.0 / (60 * 10);	// Stamina fully recovers in 10 seconds when not dazed
	this.staminaRecoveryPerFrameWhenKOed = 1.0 / (60 * 2);	// Stamina fully recovers in 2 seconds
	this.maxSexMeter = 1000;
	this.weight = 100;
	
	// Animation anchor points
	this.grabX = 120;
	this.grabY = 0;
	this.grabZ = 10;
	this.throwX = 0;
	this.throwY = 0;
	this.throwZ = 350;
	this.sexPrepareX = 0;
	this.sexPrepareY = 0;
	this.sexPrepareZ = 0;
	this.cutsceneWalkX = 0;
	this.cutsceneWalkY = 0;
	
	// Special object state
	this.captive = null;
	this.comboStep = 0;
	this.lastWalkingState = States.Walk;
	this.sexMeter = this.maxSexMeter; // * 0.75;
	this.spawnSmoke = null;
	this.allowIdle = true;
	this.idleCounter = 0;
	this.drunkTimer = 0;
	
	// Collision
	this.zHeight = this.scale * 110;
	this.collisionRadius = this.scale * 10;
	
	//////////////////////////////
	// COMBAT
	//////////////////////////////
	// Hitbox
	this.hitRect = new BoundingRect();
	this.hitRect.fitToPoint({x:-this.scale * 50 / 2,y:-this.scale * 20 / 2});
	this.hitRect.expandToFit({x:this.scale * 50 / 2,y:this.scale * 20 / 2});
	this.invincibilityFrames = 0;
	
	
	// Light punch is 0.3 seconds long, that's 18 frames total
	this.lightPunchAttack = new Attack(this);
	this.lightPunchAttack.alliance = 0;
	this.lightPunchAttack.attackbox.SetBounds(100,-28,300,28);
	this.lightPunchAttack.animationTriggered = "lightpunch";
	this.lightPunchAttack.warmupframes = 1;
	this.lightPunchAttack.attackFrames = 1;
	this.lightPunchAttack.cooldownframes = 17;
	this.lightPunchAttack.damageDealt = 15;
	this.lightPunchAttack.staminaDrained = 0.1;
	this.lightPunchAttack.visualContactZ = 96 * this.scale;
	this.lightPunchAttack.zHeight = 90 * this.scale;
	this.lightPunchAttack.zSize = 30 * this.scale;
	this.lightPunchAttack.sfx = this.punchGruntSFX;
	this.lightPunchAttack.sfxDrunk = this.punchDrunkGruntSFX;
	this.lightPunchAttack.sfxVolume = 1.0;
	this.lightPunchAttack.connectWithAllies = true;
	
	// Kick is 0.3 seconds long, that's 18 frames total
	this.kickAttack = new Attack(this);
	this.kickAttack.alliance = 0;
	this.kickAttack.attackbox.SetBounds(100,-28,300,28);
	this.kickAttack.animationTriggered = "kick";
	this.kickAttack.warmupframes = 5;
	this.kickAttack.attackFrames = 1;
	this.kickAttack.cooldownframes = 12;
	this.kickAttack.damageDealt = 20;
	this.kickAttack.staminaDrained = 0.25;
	this.kickAttack.visualContactZ = 92 * this.scale;
	this.kickAttack.zHeight = 92 * this.scale;
	this.kickAttack.zSize = 30 * this.scale;
	this.kickAttack.sfx = this.kickGruntSFX;
	this.kickAttack.sfxDrunk = this.kickDrunkGruntSFX;
	this.kickAttack.sfxVolume = 1.0;
	this.kickAttack.connectWithAllies = true;
	
	// Kick is 0.3 seconds long, that's 18 frames total
	this.airKickAttack = new Attack(this);
	this.airKickAttack.attackbox.SetBounds(100,-35,300,35);
	this.airKickAttack.animationTriggered = "airkick";
	this.airKickAttack.warmupframes = 20;
	this.airKickAttack.attackFrames = 10;
	this.airKickAttack.cooldownframes = 0;
	this.airKickAttack.damageDealt = 20;
	this.airKickAttack.staminaDrained = 1.0;
	this.airKickAttack.zHeight = -30;
	this.airKickAttack.visualContactZ = -50;
	this.airKickAttack.oneHitPerEntity = true;
	//this.airKickAttack.zSize = 30 * this.scale;
	this.airKickAttack.alliance = 0;
	
	this.airKickAttack.sfx = this.tackleGruntSFX;
	this.airKickAttack.sfxVolume = 1.0;
	
	// Tackle is 0.3 seconds long, that's 18 frames total
	this.tackleAttack = new Attack(this);
	this.tackleAttack.alliance = 0; // Hit everyone
	this.tackleAttack.attackbox.SetBounds(100,-28,300,28);
	this.tackleAttack.animationTriggered = "tackle";
	this.tackleAttack.warmupframes = 8;
	this.tackleAttack.attackFrames = 1;
	this.tackleAttack.cooldownframes = 14;
	this.tackleAttack.damageDealt = 30;
	this.tackleAttack.staminaDrained = 1.0;
	this.tackleAttack.lungeX = 50;
	this.tackleAttack.lungeOnFrame = 3;
	this.tackleAttack.hitStunDealt = 1.0;
	this.tackleAttack.allowMove = true;
	this.tackleAttack.visualContactZ = 102 * this.scale;
	this.tackleAttack.zHeight = 200;
	this.tackleAttack.zSize = 200;
	this.tackleAttack.sfx = this.tackleGruntSFX;
	this.tackleAttack.sfxDrunk = this.tackleDrunkGruntSFX;
	this.tackleAttack.sfxVolume = 1.0;
	this.tackleAttack.connectWithAllies = true;
	
	this.weakTackleAttack = new Attack(this);
	this.weakTackleAttack.alliance = 0; // Hit everyone
	this.weakTackleAttack.attackbox.SetBounds(100,-50,300,50);
	this.weakTackleAttack.animationTriggered = "tackle";
	this.weakTackleAttack.warmupframes = 8;
	this.weakTackleAttack.attackFrames = 4;
	this.weakTackleAttack.cooldownframes = 15;
	this.weakTackleAttack.damageDealt = 5;
	this.weakTackleAttack.staminaDrained = 0.35;
	this.weakTackleAttack.lungeX = 65;
	this.weakTackleAttack.lungeOnFrame = 8;
	this.weakTackleAttack.hitStunDealt = 1.1;
	this.weakTackleAttack.allowMove = true;
	this.weakTackleAttack.visualContactZ = 102 * this.scale;
	this.weakTackleAttack.zHeight = 200;
	this.weakTackleAttack.zSize = 190;
	this.weakTackleAttack.sfx = this.tackleGruntSFX;
	this.weakTackleAttack.sfxVolume = 1.0;
	this.weakTackleAttack.connectWithAllies = true;
	
	// The smoke blow attack is 60 frames long
	this.smokeBlowAttack = new Attack(this);
	this.smokeBlowAttack.alliance = 0; // Hit everyone
	this.smokeBlowAttack.attackbox.SetBounds(420,-60,780,20);
	this.smokeBlowAttack.animationTriggered = "smokeblow";
	this.smokeBlowAttack.warmupframes = 30;
	this.smokeBlowAttack.attackFrames = 25;
	this.smokeBlowAttack.cooldownframes = 6;
	this.smokeBlowAttack.damageDealt = 0.0;
	this.smokeBlowAttack.corruptionDealt = 2.0;	
	this.smokeBlowAttack.staminaDrained = 0;
	this.smokeBlowAttack.hitStunDealt = 1.0;
	this.smokeBlowAttack.sfx = this.chargedSmokeSFX;
	this.smokeBlowAttack.sfxVolume = 1.0;
	this.smokeBlowAttack.zSize = 100;
	this.smokeBlowAttack.zHeight = 50;
	this.smokeBlowAttack.connectWithAllies = true;
	
	this.smokeKissAttack = new Attack(this);
	this.smokeKissAttack.alliance = 0;
	this.smokeKissAttack.damageDealt = 0.0;
	this.smokeKissAttack.corruptionDealt = 10.0;	
	this.smokeKissAttack.staminaDrained = 0;
	this.smokeKissAttack.hitStunDealt = 1.0;
	
	this.fuckAOEAttack = new Attack(this);
	this.fuckAOEAttack.alliance = 0;
	this.fuckAOEAttack.damageDealt = 0.0;
	this.fuckAOEAttack.corruptionDealt = 40.0;	
	this.fuckAOEAttack.staminaDrained = 0;
	this.fuckAOEAttack.hitStunDealt = 1.0;
	
	this.desperationAOEAttack = new Attack(this);
	this.desperationAOEAttack.animationTriggered = "desperation";
	this.desperationAOEAttack.attackbox.SetBounds(-450,-150,450,150);
	this.desperationAOEAttack.warmupframes = 60;
	this.desperationAOEAttack.attackFrames = 1;
	this.desperationAOEAttack.cooldownframes = 40;
	this.desperationAOEAttack.alliance = 0;
	this.desperationAOEAttack.damageDealt = 30.0;
	this.desperationAOEAttack.corruptionDealt = 20.0;	
	this.desperationAOEAttack.staminaDrained = 1.0;
	this.desperationAOEAttack.hitStunDealt = 1.0;
	this.desperationAOEAttack.knockbackMultiplierZ = 1.5;
	this.desperationAOEAttack.knockbackMultiplier = 1.0;
	this.desperationAOEAttack.zHeight = 300;
	this.desperationAOEAttack.zSize = 300;
	
	this.quickSmokeAttack = new Attack(this);
	this.quickSmokeAttack.alliance = 0; // Hit everyone
	this.quickSmokeAttack.attackbox.SetBounds(100,-28,370,28);
	this.quickSmokeAttack.visualContactZ = 75 * this.scale;
	this.quickSmokeAttack.zHeight = 50 * this.scale;
	this.quickSmokeAttack.zSize = 100;
	this.quickSmokeAttack.warmupframes = 45;
	this.quickSmokeAttack.attackFrames = 1;
	this.quickSmokeAttack.cooldownframes = 15;
	this.quickSmokeAttack.damageDealt = 0.0;
	this.quickSmokeAttack.corruptionDealt = 5.0;	
	this.quickSmokeAttack.staminaDrained = 0.1;
	this.quickSmokeAttack.hitStunDealt = 1.0;
	this.quickSmokeAttack.sfx = this.quickSmokeSFX;
	this.quickSmokeAttack.sfxVolume = 1.8;
	this.quickSmokeAttack.connectWithAllies = true;
	
	this.deathAOEAttack = new Attack(this);
	this.deathAOEAttack.attackbox.SetBounds(-450,-150,450,150);
	this.deathAOEAttack.warmupframes = 40;
	this.deathAOEAttack.attackFrames = 1;
	this.deathAOEAttack.cooldownframes = 1;
	this.deathAOEAttack.alliance = 0;
	this.deathAOEAttack.damageDealt = 30.0;
	this.deathAOEAttack.corruptionDealt = 20.0;	
	this.deathAOEAttack.staminaDrained = 1.0;
	this.deathAOEAttack.hitStunDealt = 1.0;
	this.deathAOEAttack.knockbackMultiplierZ = 1.5;
	this.deathAOEAttack.knockbackMultiplier = 1.0;
	
	// The grab blow attack is 30 frames long
	this.grabAttack = new Attack(this);
	this.grabAttack.alliance = 0; // Hit everyone
	this.grabAttack.attackbox.SetBounds(100,-28,300,28);
	this.grabAttack.animationTriggered = "grab";
	this.grabAttack.warmupframes = 15;
	this.grabAttack.attackFrames = 1;
	this.grabAttack.cooldownframes = 14;
	this.grabAttack.damageDealt = 0.0;
	this.grabAttack.corruptionDealt = 0.0;	
	this.grabAttack.staminaDrained = 0;
	this.grabAttack.hitStunDealt = 0.1;
	this.grabAttack.visualContactZ = 92 * this.scale;
	this.grabAttack.zHeight = 75 * this.scale;
	
	this.animationSetup();
};

Bartender.prototype.editorProperties = ['displayName','alliance','health','maxHealth'];

Bartender.prototype.GetMoveMaxVelocity = function()
{		
		if (playernoclip)
			return 100;
		
		// Enforce velocity limits
		var maxVel = this.walkMaxVel;
		if (this.state === States.Run)
			maxVel = this.runMaxVel;
		else if (this.state === States.DrunkRun)
			maxVel = this.runMaxVel * 1.5;
		else if (this.state === States.SmokeWalk)
			maxVel = this.walkMaxVel / 1.1;
		else if (this.state === States.Jump || this.state === States.Fall || this.state === States.FallHelpless)
			maxVel = this.walkMaxVel / 1.6;
		else if (this.state === States.Drag)
			maxVel = this.walkMaxVel / 1.2;
		
		if (this.drunkTimer > 0)
			maxVel = maxVel / 1.5;
		
		return maxVel;
};

Bartender.prototype.GetStaminaRecovery = function()
{
	if (IsInvulnerable(this.state))
		return this.staminaRecoveryPerFrameWhenKOed;
	else
		return this.staminaRecoveryPerFrame; // Stamina fully recovers in 5 seconds when not dazed
};

Bartender.prototype.Respawn = function(pos)
{
 	EntityRespawn.call(this, pos);
 	this.ChangeState(States.Spawning);
	this.gravity = -gravity;
	this.velZ = -7.5;
	this.invincibilityFrames = this.posZ / -this.velZ + 4;
	
	if (this.sexMeter < this.maxSexMeter * 0.75)
		this.sexMeter = this.maxSexMeter * 0.75;
	
	// Attacks
	this.comboStep = 0;
};

Bartender.prototype.DrawSprite = function()
{
	var notInvincible = (this.invincibilityFrames % 10 < 5) ;
	
	if (this.state === States.Spawning)
		notInvincible = true;
	
	// Draw shadow
	drawEntityRoundShadow(this,275);
	
	// Draw the base sprite
	if (this.animationModel.state === "grab" || this.animationModel.state === "dragIdle" || this.animationModel.state === "drunkdragIdle")
	{
		// Draw the base bartender's legs and upper body
		if (notInvincible) this.animationModel.DrawBase();
		// Draw the captive entity (if one exists)
		if (notInvincible) this.DrawCaptive();
		// Draw the forearm
		if (notInvincible) this.animationModel.DrawDecorator(0);
	}
	else if (this.animationModel.state === "drag" || this.animationModel.state === "drunkdrag" )
	{
		if (notInvincible) this.animationModel.DrawBase();
		// Draw a decorator, if one exists
		if (notInvincible) this.animationModel.DrawDecorator(0);
		// Draw the captive entity (if one exists)
		this.DrawCaptive();
		// Draw the forearm
		if (notInvincible) this.animationModel.DrawDecorator(1);
	}
	else if (this.animationModel.state === this.sexAnim)
	{
		// Draw the bartender and captive combined sprite (do not draw the captive)
		if (notInvincible) this.animationModel.DrawBase();
	}
	else if (this.animationModel.state === "throw" || this.animationModel.state === "smokekissjoe")
	{
		// Draw most of the bartender
		if (notInvincible) this.animationModel.DrawBase();
		// Draw the captive entity
		this.DrawCaptive();
		// Draw the forearm
		if (notInvincible) this.animationModel.DrawDecorator(0);
	}
	else if (this.animationModel.state === "captivepunch" || this.animationModel.state === "captivefinish")
	{
		// Draw most of the bartender
		if (notInvincible) this.animationModel.DrawBase();
		// Draw the captive entity
		this.DrawCaptive();
	}
	else
	{
		if (notInvincible) this.animationModel.Draw();
		if (this.captive !== null)
			this.DrawCaptive();
	}
}

Bartender.prototype.DrawCaptive = function()
{
	if (this.captive !== null)
	{	
		var extraOffsetX = 0;
		var extraOffsetY = 0;
		if (this.animationModel.GetState().lastDisplayedFrame !== null)
		{
			extraOffsetX = this.animationModel.GetState().lastDisplayedFrame.offsetX * this.scale;
			extraOffsetY = this.animationModel.GetState().lastDisplayedFrame.offsetY * this.scale;
		}
		
    	ctx.translate(this.captive.posX - this.posX + extraOffsetX*this.facing, this.captive.posY - this.posY + extraOffsetY);
		this.captive.DrawSprite();
		
		ctx.translate(-(this.captive.posX - this.posX + extraOffsetX*this.facing), -(this.captive.posY - this.posY + extraOffsetY));
	}
}

Bartender.prototype.DrawCaptiveBase = function()
{
	if (this.captive !== null)
	{
		var extraOffsetX = 0;
		var extraOffsetY = 0;
		if (this.animationModel.GetState().lastDisplayedFrame !== null)
		{
			extraOffsetX = this.animationModel.GetState().lastDisplayedFrame.offsetX * this.scale;
			extraOffsetY = this.animationModel.GetState().lastDisplayedFrame.offsetY * this.scale;
		}
		
    	ctx.translate(this.captive.posX - this.posX + extraOffsetX*this.facing, this.captive.posY - this.posY + extraOffsetY);
		this.captive.animationModel.DrawBase();
		ctx.translate(-(this.captive.posX - this.posX + extraOffsetX*this.facing), -(this.captive.posY - this.posY + extraOffsetY));
	}
}

Bartender.prototype.DrawCaptiveDecorator = function(layer)
{
	if (this.captive !== null)
	{		
		var extraOffsetX = 0;
		var extraOffsetY = 0;
		if (this.animationModel.GetState().lastDisplayedFrame !== null)
		{
			extraOffsetX = this.animationModel.GetState().lastDisplayedFrame.offsetX * this.scale;
			extraOffsetY = this.animationModel.GetState().lastDisplayedFrame.offsetY * this.scale;
		}
		
    	ctx.translate(this.captive.posX - this.posX + extraOffsetX*this.facing, this.captive.posY - this.posY + extraOffsetY);
		this.captive.animationModel.DrawDecorator(layer);
		ctx.translate(-(this.captive.posX - this.posX + extraOffsetX*this.facing), -(this.captive.posY - this.posY + extraOffsetY));
	}
}

Bartender.prototype.GetGrabCandidate = function()
{
	// Look through all the entities for one that is grabbable and within range
	var entitiesInRange = this.grabAttack.GetEntitiesInRange();
	var nearestEntity = null;
	var nearestdistance = 1000;
	
	for (var i=0; i < entitiesInRange.length; i++)
	{
		if (entitiesInRange[i].grabbable && !IsInvulnerable(entitiesInRange[i].state))
		{
			var dist = distanceActorToActor(this,entitiesInRange[i]);
			if (dist < nearestdistance)
			{
				nearestdistance = dist;
				nearestEntity = entitiesInRange[i];
			}
		}
	}
	
	return nearestEntity;
};

Bartender.prototype.GetFuckCandidate = function()
{
	// Look through all the entities for one that is fuckable and within range
	var entitiesInRange = this.grabAttack.GetEntitiesInRange();
	var nearestEntity = null;
	var nearestdistance = 1000;
	
	for (var i=0; i < entitiesInRange.length; i++)
	{
		if (entitiesInRange[i].fuckable && (entitiesInRange[i].state === States.Corrupt || entitiesInRange[i].state === States.PreCorrupt))
		{
			var dist = distanceActorToActor(this,entitiesInRange[i]);
			if (dist < nearestdistance)
			{
				nearestdistance = dist;
				nearestEntity = entitiesInRange[i];
			}
		}
	}
	
	return nearestEntity;
};

Bartender.prototype.SetupSexAnimation = function(captive)
{
	// sex_bootremoval.mp3
	// sex_Joe1.mp3
	// sex_Joe1a.mp3
	// sex_Joe1Drunk.mp3
	// sex_Joe2.mp3
	// sex_Joe2Drunk.mp3
	// sex_Joe3.mp3
	// sex_Joe3Drunk.mp3
	// sex_Joe4.mp3
	// sex_Joe4Drunk.mp3
	// sex_pantremoval.mp3
	
	if (captive instanceof Joe0 || captive instanceof Joe1)
	{
		if (this.drunkTimer > 0)
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe1drunk";
			this.beforeSexAnim = "beforesex/joe1drunk";
			this.sexAnim = "sex/joe1drunk";
			this.afterSexAnim = "aftersex/joe1drunk";
			this.captiveOffsetX = 116;
			this.captiveOffsetY = -18;
			this.captiveOffsetZ = 0;
			captive.sexType = 1;
			this.sexSFX = new SuspendableSound("sex_Joe1Drunk"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
		else
		{
			// If corruption is at 50%, start showing the joe anal animation
			if (Math.random() < (enemiesCorrupted / totalEnemies) && (enemiesCorrupted > totalEnemies/2.0))
			{
				// Sex animation flags
				this.prepareSexAnim = "preparesex/joe1anal";
				this.beforeSexAnim = "beforesex/joe1anal";
				this.sexAnim = "sex/joe1anal";
				this.afterSexAnim = "aftersex/joe1anal";
				this.captiveOffsetX = 119;
				this.captiveOffsetY = -6;
				this.captiveOffsetZ = 0;
				captive.sexType = 2;
				this.sexSFX = new SuspendableSound("sex_Joe1a"); //this.bartenderThrustSFX;
				this.sexSFXDelay = 0;
			}
			else
			{
				// Sex animation flags
				this.prepareSexAnim = "preparesex/joe1";
				this.beforeSexAnim = "beforesex/joe1";
				this.sexAnim = "sex/joe1";
				this.afterSexAnim = "aftersex/joe1";
				this.captiveOffsetX = 119;
				this.captiveOffsetY = -18;
				this.captiveOffsetZ = 0;
				captive.sexType = 0;
				this.sexSFX = new SuspendableSound("sex_Joe1"); //this.bartenderThrustSFX;
				this.sexSFXDelay = 0;
			}
		}
	}
	else if (captive instanceof Joe2)
	{
		if (this.drunkTimer > 0)
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe2drunk";
			this.beforeSexAnim = "beforesex/joe2drunk";
			this.sexAnim = "sex/joe2drunk";
			this.afterSexAnim = "aftersex/joe2drunk";
			this.captiveOffsetX = 46*3;
			this.captiveOffsetY = -4*3;
			this.captiveOffsetZ = 0;
			captive.sexType = 1;
			this.sexSFX = new SuspendableSound("sex_Joe2Drunk"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
		else
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe2";
			this.beforeSexAnim = "beforesex/joe2";
			this.sexAnim = "sex/joe2";
			this.afterSexAnim = "aftersex/joe2";
			this.captiveOffsetX = 119;
			this.captiveOffsetY = -18;
			this.captiveOffsetZ = 0;
			captive.sexType = 0;
			this.sexSFX = new SuspendableSound("sex_Joe2"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
	}
	else if (captive instanceof Joe3)
	{
		if (this.drunkTimer > 0)
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe3drunk";
			this.beforeSexAnim = "beforesex/joe3drunk";
			this.sexAnim = "sex/joe3drunk";
			this.afterSexAnim = "aftersex/joe3drunk";
			this.captiveOffsetX = 119;
			this.captiveOffsetY = -18;
			this.captiveOffsetZ = 0;
			captive.sexType = 1;
			this.sexSFX = new SuspendableSound("sex_Joe3Drunk"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
		else
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe3";
			this.beforeSexAnim = "beforesex/joe3";
			this.sexAnim = "sex/joe3";
			this.afterSexAnim = "aftersex/joe3";
			this.captiveOffsetX = 119;
			this.captiveOffsetY = -18;
			this.captiveOffsetZ = 0;
			captive.sexType = 0;
			this.sexSFX = new SuspendableSound("sex_Joe3"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
	}
	else if (captive instanceof Joe4)
	{
		if (this.drunkTimer > 0)
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe4drunk";
			this.beforeSexAnim = "beforesex/joe4drunk";
			this.sexAnim = "sex/joe4drunk";
			this.afterSexAnim = "aftersex/joe4drunk";
			this.captiveOffsetX = 140;
			this.captiveOffsetY = -9;
			this.captiveOffsetZ = 0;
			captive.sexType = 1;
			this.sexSFX = new SuspendableSound("sex_Joe4Drunk"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
		else
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe4";
			this.beforeSexAnim = "beforesex/joe4";
			this.sexAnim = "sex/joe4";
			this.afterSexAnim = "aftersex/joe4";
			this.captiveOffsetX = 200;
			this.captiveOffsetY = -9;
			this.captiveOffsetZ = 0;
			captive.sexType = 0;
			this.sexSFX = new SuspendableSound("sex_Joe4"); //this.bartenderThrustSFX;
			this.sexSFXDelay = 0;
		}
	}
	
	else if (captive instanceof Joe5)
	{
		if (captive.lastState === States.PreCorrupt)
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe5precorrupt";	// none needed, use fake idle state
			this.beforeSexAnim = "beforesex/joe5precorrupt";		// use normal walking animation
			this.sexAnim = "";							// not used
			this.afterSexAnim = "";						// not used
			this.captiveOffsetX = 83 * 3;
			this.captiveOffsetY = 6;
			this.captiveOffsetZ = 0;
			captive.sexType = 0;
			this.sexSFX = null;
		}
		else
		{
			// Sex animation flags
			this.prepareSexAnim = "preparesex/joe5";
			this.beforeSexAnim = "beforesex/joe5";
			this.sexAnim = "sex/joe5";
			this.afterSexAnim = "preparesex/joe5";
			this.captiveOffsetX = 0;
			this.captiveOffsetY = 1;
			this.captiveOffsetZ = 0;
			captive.sexType = 1;
			this.sexSFX = null;
		}
	}
};

Bartender.prototype.UpdateState = function()
{
	if (this.drunkTimer > 0)
	{
		this.animationModel.ApplyPrefix("drunk");
		
		if (!permadrunk)
			this.drunkTimer -= 1;
		
		if (this.animationModel.state === "idle")
			this.animationModel.ChangeState("drunkidle");
		else if (this.animationModel.state === "walk")
			this.animationModel.ChangeState("drunkwalk");
		else if (this.animationModel.state === "smokeidle")
			this.animationModel.ChangeState("drunksmokeidle");
		else if (this.animationModel.state === "smokewalk")
			this.animationModel.ChangeState("drunksmokewalk");
			
		if (this.state === States.Run)
		{
			this.ChangeState(States.DrunkRun);
		}
	}
	else
	{
		this.animationModel.ClearPrefix("drunk");
		
		if (this.animationModel.state === "drunkidle")
			this.animationModel.ChangeState("idle");
		else if (this.animationModel.state === "drunkwalk")
			this.animationModel.ChangeState("walk");
		else if (this.animationModel.state === "drunksmokeidle")
			this.animationModel.ChangeState("smokeidle");
		else if (this.animationModel.state === "drunksmokewalk")
			this.animationModel.ChangeState("smokewalk");
		/*
		else if (this.animationModel.state === "drunksmokewalkcancel")
			this.animationModel.ChangeState("smokewalkcancel");
		else if (this.animationModel.state === "drunksmokeidlecancel")
			this.animationModel.ChangeState("smokeidlecancel");
		*/
	}
	
	if (this.invincibilityFrames > 0)
	{
		this.invincibilityFrames -= 1;
	}
	
	if (this.alphaTimer > 0)
		this.alphaTimer -= 1;
	else
		this.alpha = crawlValue(this.alpha,1.0, 0.01);
	
	var mag = Math.sqrt(Math.pow(this.velX,2)+Math.pow(this.velY,2));
	var ang = Math.atan2(this.velY,this.velX);
	
	// Do what needs to be done in each state and change the state if needed
	if (this.state === States.Walk)
	{
		this.gravity = 0;
		if (this.stateFrames <= 1)
			this.idleCounter = 0;
	
		this.lastWalkState = this.state;
		if (mag < 2.6 && !this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
		{				
			if (this.stateFrames === 1 && (this.lastState === States.Spawning || this.lastState === States.Fall || this.lastState === States.FallHelpless || this.lastState === States.Jump || this.lastState === States.AirKick ))
			{
				this.landingSFX.Play(3.0);
			}
			
			if (this.idleCounter === 0)
			{
				if (this.drunkTimer > 0)
					this.animationModel.ChangeState("drunkidle");
				else
					this.animationModel.ChangeState("idle");
			}
			else if (this.idleCounter === 800)
			{
				if (this.drunkTimer > 0)
					this.animationModel.ChangeState("drunksmokeidle");
				else
					this.animationModel.ChangeState("smokeidle");
			}
			else if (this.idleCounter === 1100)
			{
				if (this.drunkTimer === 0)
					this.animationModel.ChangeState("smokeidleblow");
			}
			else if (this.animationModel.state === "smokeidleblow" && 	
					 this.animationModel.animations["smokeidleblow"].decoratorAnimations[0].lastDisplayedFrameIndex === 5 &&
					 this.animationModel.animations["smokeidleblow"].decoratorAnimations[0].lastFrameWasTransition)
			{
				var smokeRing = new EffectAnimation(this.smokeRingAnim, this, false);
				//smokeRing.spriteCenterX = 50;
				//smokeRing.spriteCenterY = 50;
				smokeRing.facing = this.facing;
				smokeRing.posX = this.posX + this.facing * 10 * 3;
				smokeRing.posY = this.posY;
				smokeRing.posZ = 120 * 3;
				this.smokeBlowLowSFX.Play(1.0);
				level.entities.AddEffect(smokeRing);
			}
			else if (this.idleCounter > 1100 && this.animationModel.animations["smokeidleblow"].decoratorAnimations[0].done)
			{
				this.idleCounter = 800;
				if (this.drunkTimer === 0)
				{
					this.animationModel.ChangeState("smokeidle");
					this.animationModel.SetAllPositions("smokeidle", 0.26);
				}
			}
			
			if (this.allowIdle)
				this.idleCounter += 1;
			else
				this.idleCounter = 0;
				
		}
		else
		{
			this.idleCounter = 0;
			
			
			if (this.animationModel.state === "smokeidle" || this.animationModel.state === "smokewalk")
			{
				this.animationModel.ChangeState("smokewalkcancel");
			}
			else if (this.animationModel.state === "smokewalkcancel")
			{
				if (this.animationModel.animations["smokewalkcancel"].decoratorAnimations[0].done)
					this.animationModel.ChangeState("walk");
			}
			else if (this.animationModel.state === "drunksmokeidle" || this.animationModel.state === "drunksmokewalk")
			{
				this.animationModel.ChangeState("drunksmokewalkcancel");
			}
			else if (this.animationModel.state === "drunksmokewalkcancel")
			{
				if (this.animationModel.animations["drunksmokewalkcancel"].decoratorAnimations[0].done)
				{
					if (this.drunkTimer > 0)
						this.animationModel.ChangeState("drunkwalk");
					else
						this.animationModel.ChangeState("walk");
				}
			}
			else
			{
				if (this.drunkTimer > 0)
					this.animationModel.ChangeState("drunkwalk");
				else
					this.animationModel.ChangeState("walk");
			}
		}
		
				// Play the drag sfx
		if (this.animationModel.state == "smokeidle" &&
		 	this.animationModel.animations["smokeidle"].decoratorAnimations[0].lastDisplayedFrameIndex === 3 && 
		    this.animationModel.animations["smokeidle"].decoratorAnimations[0].lastFrameWasTransition &&
		    this.animationModel.animations["smokeidle"].decoratorAnimations[0].direction === 1 )
		{
			this.puffAndDragSFX.Play(0.25);
		}
		else if (this.animationModel.state == "drunksmokeidle" &&
		 	this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].lastDisplayedFrameIndex === 3 && 
		    this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].lastFrameWasTransition &&
		    this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].direction === 1 )
		{
			this.puffAndDragSFX.Play(0.25);
		}
		
		// Spawn a puff of smoke
		if (this.animationModel.state == "smokeidle" && this.animationModel.animations["smokeidle"].decoratorAnimations[0].startFrame)
		{
			var puff = new SmokePuff(this,0,111);
			puff.velZ += 1;
			level.entities.AddEffect(puff);
		}
		else if (this.animationModel.state == "drunksmokeidle" && this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].startFrame)
		{
			var puff = new SmokePuff(this,0,111);
			puff.velZ += 1;
			level.entities.AddEffect(puff);
		}
		
		if ((this.animationModel.state == "walk" || this.animationModel.state == "smokewalk") && this.animationModel.GetLastFrameWasTransition())
		{
			if (this.animationModel.GetLastFrameIndex() == 0)
				this.footstep_walk1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 4)
				this.footstep_walk2.Play(1.0);
		}
		
		if ((this.animationModel.state == "drunkwalk" || this.animationModel.state == "drunksmokewalk") && this.animationModel.GetLastFrameWasTransition())
		{
			if (this.animationModel.GetLastFrameIndex() == 2)
				this.footstep_walk1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 6)
				this.footstep_walk2.Play(1.0);
		}
		
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		// Change to Run state
		if (this.controller.leftDoubleTap() || this.controller.rightDoubleTap())
		{
			if (this.drunkTimer > 0)
				this.ChangeState(States.DrunkRun);
			else
				this.ChangeState(States.Run);
		}
		
		// Change to sidehop state
		if (this.controller.upDoubleTap() || this.controller.downDoubleTap())
		{
			this.ChangeState(States.Sidehop);
		}
		
		// Change to SmokeWalk state
		if (this.controller.smoke)
			this.ChangeState(States.SmokeWalk);
		
		// Change to jump state
		if (this.controller.jumpActivate())
		{
			this.ChangeState(States.Jump);
		}
		
		// Change to Fuck or Grab State
		if (this.controller.grabActivate())
		{
			var fuckCandidate = this.GetFuckCandidate();
			if (fuckCandidate !== null && this.sexMeter === this.maxSexMeter)
			{
				var attemptedCaptive = fuckCandidate.Capture(this);
				if (attemptedCaptive !== null)
				{
					this.SetupSexAnimation(attemptedCaptive);
					this.captive = attemptedCaptive;
					this.ChangeState(States.PrepareSexTop);
				}
				else
				{
					this.ChangeState(States.Idle);
				}
			}
			else
			{
				this.attack = this.grabAttack;
				this.attack.Attack();
				this.animationModel.ChangeState(this.attack.animationTriggered);
				this.ChangeState(States.Grab);
			}
		}
		
		// Change to attack state
		if (this.controller.punch && this.controller.punchFramesSinceKeydown < 6)
		{	
			if (this.comboStep < 4 && this.framesSinceLastConnectingAttack < 40)
			{
				this.comboStep+=1;
			}
			else
			{
				this.comboStep=0;
			}
			
			if (this.comboStep >= 0 && this.comboStep <= 1)
			{
				this.attack = this.lightPunchAttack;
			}
			else if (this.comboStep >= 2 && this.comboStep <= 3)
			{
				this.attack = this.kickAttack;
			}
			else if (this.comboStep >= 4)
			{
				this.attack = this.tackleAttack;
			}
			this.attack.Attack();
			this.animationModel.ChangeState(this.attack.animationTriggered);
			this.ChangeState(States.BasicAttack);
			
			//var testProjectile = new CoffeeProjectile(this, 200, 300);
			//testProjectile.attack.alliance = 1;
			//level.entities.AddEffect(testProjectile);
		}
		

		
		// Check for desperation attack
		if ((this.controller.punch && this.controller.punchFramesSinceKeydown < 15 &&
			this.controller.smoke && this.controller.smokeFramesSinceKeydown < 15) ||
			this.controller.special && this.controller.specialFramesSinceKeydown < 15)
		{
			this.CancelAttack();
			this.ChangeState(States.DesperationAttack);
		}
		
		// If the ground is missing, go to the fall helpless state
		if (this.posZ > 0)
		{
			this.ChangeState(States.FallHelpless);
		}
		
	}
	else if (this.state === States.DrunkRun)
	{
		this.lastWalkState = this.state;
		
		this.animationModel.ChangeState("drunkrun");
			
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		if (this.animationModel.GetLastFrameWasTransition() && (this.animationModel.GetLastFrameIndex() == 0 || this.animationModel.GetLastFrameIndex() == 4))
		{
			if (this.animationModel.GetLastFrameIndex() == 0)
				this.footstep_run1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 4)
				this.footstep_run2.Play(0.4);
		}
	
		// Transition to a regular walk
		if (!this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
			this.ChangeState(States.Walk);	
		else if (this.animationModel.AnimationIsComplete("drunkrun"))
		{
			this.animationModel.SetAllPositions("drunkrun", 0);
			this.ChangeState(States.DrunkRunFall);
			this.drunkStumbleSFX.Play(1.0, -0.1);
			this.velX += 10 * this.facing;
		}
	}
	else if (this.state === States.DrunkRunFall)
	{
		this.animationModel.ChangeState("drunkrunfall");
		
		if (this.animationModel.AnimationIsComplete("drunkrunfall"))
		{
			this.ChangeState(States.Walk);
		}
	}
	else if (this.state === States.Run)
	{
		this.lastWalkState = this.state;
		this.animationModel.ChangeState("run");
		
		if (this.animationModel.GetLastFrameWasTransition() && (this.animationModel.GetLastFrameIndex() == 0 || this.animationModel.GetLastFrameIndex() == 4))
		{
			if (this.animationModel.GetLastFrameIndex() == 0)
				this.footstep_run1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 4)
				this.footstep_run2.Play(0.4);
		}
			
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		// Transition to a regular walk
		if (!this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
			this.ChangeState(States.Walk);
		
		// Transition to jump
		if (this.controller.jumpActivate())
		{
			this.ChangeState(States.Jump);
		}
		
		// Change to Fuck or Grab State
		if (this.controller.grabActivate())
		{
			var fuckCandidate = this.GetFuckCandidate();
			if (fuckCandidate !== null && this.maxSexMeter === this.sexMeter)
			{
				var attemptedCaptive = fuckCandidate.Capture(this);
				if (attemptedCaptive !== null)
				{
					this.SetupSexAnimation(attemptedCaptive);
					this.captive = attemptedCaptive;
					this.ChangeState(States.PrepareSexTop);
				}
				else
				{
					this.ChangeState(States.Idle);
				}
			}
			else
			{
				this.attack = this.grabAttack;
				this.attack.Attack();
				this.animationModel.ChangeState(this.attack.animationTriggered);
				this.ChangeState(States.Grab);
			}
		}
		
		// Change to sidehop state
		if (this.controller.upDoubleTap() || this.controller.downDoubleTap())
		{
			this.ChangeState(States.Sidehop);
		}
		
		// Transition to a smoking walk
		if (this.controller.smoke && this.controller.smokeFramesSinceKeydown < 6)
		{
			this.ChangeState(States.Dash);
			this.jumpSFX.Play();
		}
		// Transition to the tackle state
		else if (this.controller.punch && this.controller.punchFramesSinceKeydown < 6)
		{
			this.attack = this.weakTackleAttack;
			this.attack.Attack();
			this.animationModel.ChangeState(this.attack.animationTriggered);
			this.ChangeState(States.Tackle);
		}
		
		// If the ground is missing, go to the fall helpless state
		if (this.posZ > 0)
		{
			this.ChangeState(States.FallHelpless);
		}
	}
	else if (this.state === States.SmokeWalk)
	{
		this.lastWalkState = this.state;
		
		
		if (mag < 2.6 && !this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
		{
			if (this.drunkTimer > 0)
				this.animationModel.ChangeState("drunksmokeidle");
			else
				this.animationModel.ChangeState("smokeidle");
		}
		else
		{
			if (this.drunkTimer > 0)
				this.animationModel.ChangeState("drunksmokewalk");
			else
				this.animationModel.ChangeState("smokewalk");
		}
			
		if (this.animationModel.state == "walk" || this.animationModel.state == "smokewalk" && this.animationModel.GetLastFrameWasTransition())
		{
			if (this.animationModel.GetLastFrameIndex() == 0)
				this.footstep_walk1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 4)
				this.footstep_walk2.Play(1.0);
		}
		else if (this.animationModel.state == "drunkwalk" || this.animationModel.state == "drunksmokewalk" && this.animationModel.GetLastFrameWasTransition())
		{
			if (this.animationModel.GetLastFrameIndex() == 2)
				this.footstep_walk1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 6)
				this.footstep_walk2.Play(1.0);
		}
			
		// Play the drag sfx
		if (this.animationModel.animations["smokeidle"].decoratorAnimations[0].lastDisplayedFrameIndex === 3 && 
		    this.animationModel.animations["smokeidle"].decoratorAnimations[0].lastFrameWasTransition &&
		    this.animationModel.animations["smokeidle"].decoratorAnimations[0].direction === 1 )
		{
			this.puffAndDragSFX.Play(0.5);;
		}
		else if (this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].lastDisplayedFrameIndex === 3 && 
		    this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].lastFrameWasTransition &&
		    this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].direction === 1 )
		{
			this.puffAndDragSFX.Play(0.5);;
		}
		
		// Spawn a puff of smoke
		if (this.animationModel.animations["smokeidle"].decoratorAnimations[0].startFrame)
		{
			var puff = new SmokePuff(this,0,111);
			puff.velZ += 1;
			level.entities.AddEffect(puff);
		}
		else if (this.animationModel.animations["drunksmokeidle"].decoratorAnimations[0].startFrame)
		{
			var puff = new SmokePuff(this,0,111);
			puff.velZ += 1;
			level.entities.AddEffect(puff);
		}
		
		// Move the character based on controller input
		this.ProcessDirectionalInput();

		// The only way to end a smoke walk is to release K and blow smoke
		//if (this.drunkTimer === 0)
		{
			var hitloopend = this.animationModel.animations[this.animationModel.state].decoratorAnimations[0].hitLoopEnd;
			
			//var hitloopend = false;
			//if (this.animationModel.state === "smokewalk")
			//	hitloopend = this.animationModel.animations["smokewalk"].decoratorAnimations[0].hitLoopEnd;
			//else if (this.animationModel.state === "drunksmokewalk")
			//	hitloopend = this.animationModel.animations["drunksmokewalk"].decoratorAnimations[0].hitLoopEnd;
			
			if (!this.controller.smoke && hitloopend)
			{
				this.attack = this.smokeBlowAttack;
				this.attack.Attack();
				this.animationModel.ChangeState(this.attack.animationTriggered);
				level.entities.AddEffect(new BlownSmoke(this));
				this.ChangeState(States.BlowSmoke);
			}
			else if (!this.controller.smoke && !hitloopend && this.controller.smokeFramesSinceKeydown < 15)
			{
				this.ChangeState(States.QuickSmokeAttack);
			}
			else if ((this.controller.punch && this.controller.punchFramesSinceKeydown < 15 &&
			this.controller.smoke && this.controller.smokeFramesSinceKeydown < 15) ||
			this.controller.special && this.controller.specialFramesSinceKeydown < 15)
			{
				this.CancelAttack();
				this.ChangeState(States.DesperationAttack);
			}
		}
		//else if (!this.controller.smoke)
		//{
		//	this.ChangeState(States.Walk);
		//}
		
		// If the ground is missing, go to the fall helpless state
		if (this.posZ > 0)
		{
			this.ChangeState(States.FallHelpless);
		}
	
	}
	else if (this.state === States.AirKick)
	{
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		if (this.stateFrames === 18)
		{
			this.velX += this.facing * 20;
			this.velZ = 0;
			
			this.attack.PlaySFX();
		}
		
		// Wait until the airkick is done
		if (this.posZ <= 0)
		{
			this.CancelAttack();
			this.ChangeState(States.Walk);
		}
		
		this.ChangeStateOnAttackComplete(States.FallHelpless);
	}
	else if (this.state === States.DesperationAttack)
	{
		if (this.stateFrames === 1)
		{
			this.CancelAttack();
			this.attack = this.desperationAOEAttack;
			this.attack.Attack();
			this.animationModel.ChangeState(this.attack.animationTriggered);
			
			this.desperationSFX.Play();
		}
		
		// Spawn in the smoke explosion
		if (this.animationModel.GetLastFrameIndex() === 13 && this.animationModel.GetLastFrameWasTransition())
		{
			var desperationSmoke = new EffectAnimation(this.desperationSmokeAnim, this, false);
			//desperationSmoke.spriteCenterX = 180;
			//desperationSmoke.spriteCenterY = 214;
			level.entities.AddEffect(desperationSmoke);
		}
		
		if (this.stateFrames > 1)
		{
			this.ChangeStateOnAttackComplete(States.Walk);
		}
	}
	else if (this.state === States.QuickSmokeAttack)
	{
		if (this.stateFrames === 1)
		{
			this.CancelAttack();
			this.attack = this.quickSmokeAttack;
			this.attack.Attack();
			this.animationModel.ChangeState("smokechargefast");
			
			// Fast forward the animation and attack to blend...
			for (var i = 0; i < this.lastStateFrames && i < 25; i++)
			{
				this.animationModel.Update();
				this.attack.Update();
			}
			
			this.attack.PlaySFX();
		}
			
		if (this.animationModel.animations["smokechargefast"].decoratorAnimations[0].done)
		{
			this.animationModel.ChangeState("quicksmoke");
		}
	
		// Spawn in the smoke explosion
		if (this.animationModel.state === "quicksmoke" && this.animationModel.GetLastFrameIndex() === 3 && this.animationModel.GetLastFrameWasTransition())
		{
			this.quickSmokeBlowSFX.Play(2.5);
			var quickSmoke = new EffectAnimation(this.quicksmokeSmokeAnim, this, false);
			level.entities.AddEffect(quickSmoke);
		}
		
		if (this.stateFrames > 1)
		{
			this.ChangeStateOnAttackComplete(States.Walk);
		}
	}
	else if (this.state === States.Dash)
	{
		/// Check for desperation attack
		if ((this.controller.punch && this.controller.punchFramesSinceKeydown < 15 &&
			this.controller.smoke && this.controller.smokeFramesSinceKeydown < 15) ||
			this.controller.special && this.controller.specialFramesSinceKeydown < 15)
		{	
			this.CancelAttack();
			this.ChangeState(States.DesperationAttack);
		}
	
		if (this.stateFrames < 24)
			this.animationModel.ChangeState("dash");
		else
			this.animationModel.ChangeState("idle");
		if (this.stateFrames < 10 && this.stateFrames > 6)
		{
			this.orderBonus = 40;
			this.velX = 85 * this.facing;
		}
		else if (this.stateFrames === 16)
		{
			this.velX = 12 * this.facing;
		}
		else if (this.stateFrames === 30)
		{
			this.ChangeState(States.Walk);
		}
		this.velY = 0;
	}
	else if (this.state === States.Jump)
	{
		if (this.stateFrames === 1)
		{
			this.jumpSFX.Play(2.0);
		}
	
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		this.animationModel.ChangeState("jump");
		if (this.controller.jump && this.stateFrames < this.maxJumpFrames)
		{
			this.accelZ = 10.0;
		}
		else
		{
			this.ChangeState(States.Fall);
		}
		
		if (this.controller.punchActivate())
		{
			this.attack = this.airKickAttack;
			this.attack.Attack();
			this.animationModel.ChangeState(this.attack.animationTriggered);
			this.ChangeState(States.AirKick);
		}
	}
	
	else if (this.state === States.Sidehop)
	{
		this.animationModel.ChangeState("jump");
		
		if (this.stateFrames === 1)
		{
			this.jumpSFX.Play(2.0);
			this.velZ += 25;
			this.posZ += 1;
			if (this.controller.upFramesSinceKeydown < this.controller.downFramesSinceKeydown)
			{
				this.velY -= 5;
			}
			else
			{
				this.velY += 5;
			}
		}
		
		if (this.stateFrames === 10)
		{
			if (this.controller.upFramesSinceKeydown < this.controller.downFramesSinceKeydown)
			{
				this.velY += 5;
			}
			else
			{
				this.velY -= 5;
			}
		}
	
		// Move the character based on controller input
		//this.ProcessDirectionalInput();
		
		if (this.stateFrames === 25)
		{
			if (this.invincibilityFrames < 5)
				 this.invincibilityFrames = 5;
			this.ChangeState(States.Walk);
		}
	}
	
	else if (this.state === States.Spawning)
	{
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		if (this.stateFrames === 1)
		{
			this.spawnSmoke = new EffectAnimation(this.smokedescent, this, true);
			level.entities.AddEffect(this.spawnSmoke);
		}
		
		if (this.stateFrames === 33)
		{
			(new SuspendableSound("bartender_spawn")).Play(1.5);
		}
		
		if (this.spawnSmoke !== null)
		{
			this.spawnSmoke.posX = this.posX;
			this.spawnSmoke.posY = this.posY-1;
			this.spawnSmoke.posZ = this.posZ + 200;
		}
		
		if (this.velZ > 0)
			this.animationModel.ChangeState("jump");
		else
			this.animationModel.ChangeState("fall");
		
		if (this.posZ <= 0)
		{
			if (this.spawnSmoke != null)
			{
				// Once the bartender touches the ground, unhook the effect and let it play out on its own
				this.spawnSmoke.owner = null;
				this.spawnSmoke.EffectAnimationAnim.inheritFacing = 0;	
				this.spawnSmoke.EffectAnimationAnim.owner = null;
				this.spawnSmoke.trackOwner = false;
				this.spawnSmoke.velX = 0;
				this.spawnSmoke.velY = 0;
				this.spawnSmoke.velZ = 0;
				
				this.spawnSmoke = null;
			}
			
			this.ChangeState(States.Walk);
		}
	}
	else if (this.state === States.Fall)
	{
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		if (this.velZ > 0)
			this.animationModel.ChangeState("jump");
		else
			this.animationModel.ChangeState("fall");
		
		if (this.posZ <= 0)
			this.ChangeState(States.Walk);
			
		if (this.controller.punchActivate())
		{
			this.attack = this.airKickAttack;
			this.attack.Attack();
			this.animationModel.ChangeState(this.attack.animationTriggered);
			this.ChangeState(States.AirKick);
		}
	}
	else if (this.state === States.FallHelpless)
	{
		this.lastWalkState = States.Walk;
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		this.animationModel.ChangeState("fall");
		if (this.posZ <= 0)
			this.ChangeState(States.Walk);
	}
	else if (this.state === States.BasicAttack)
	{
		if ((this.controller.punch && this.controller.punchFramesSinceKeydown < 15 &&
			this.controller.smoke && this.controller.smokeFramesSinceKeydown < 15) ||
			this.controller.special && this.controller.specialFramesSinceKeydown < 15)
		{
			this.CancelAttack();
			this.ChangeState(States.DesperationAttack);
		}
		else
		{
			this.attack.PlaySFX();
			this.ChangeStateOnAttackComplete(States.Walk);
		}
	}
	else if (this.state === States.BlowSmoke)
	{
		if (this.stateFrames === 20)
			this.attack.PlaySFX();
			
		this.ChangeStateOnAttackComplete(States.Walk);
	}
	else if (this.state === States.Tackle)
	{
		if ((this.controller.punch && this.controller.punchFramesSinceKeydown < 15 &&
			this.controller.smoke && this.controller.smokeFramesSinceKeydown < 15) ||
			this.controller.special && this.controller.specialFramesSinceKeydown < 15)
		{
			this.CancelAttack();
			this.ChangeState(States.DesperationAttack);
		}
		else
		{
			this.attack.PlaySFX();
			this.ChangeStateOnAttackComplete(States.Walk);
		}
	}
	else if (this.state === States.HitStun)
	{
		if (this.stateFrames === 1)
			this.animationModel.animations["hitstun"].mainAnimation.Reset();
		this.animationModel.ChangeState("hitstun");
		this.hitStunFrames -= 1.0;
		this.CancelAttack();
		
		if (this.hitStunFrames <= 0)
		{
			this.hitStunFrames = 0;
			this.ChangeState(States.Walk);
		}
	}
	else if (this.state === States.CaptiveHitStun)
	{
		this.animationModel.ChangeState("hitstun");
		this.hitStunFrames -= 1.0;
		
		this.CancelAttack();
		
		if (this.hitStunFrames <= 0)
		{
			this.hitStunFrames = 0;
			this.ChangeState(States.Captive);
		}
	}
	else if (this.state === States.KnockedOut)
	{
	
		if (this.stateFrames === 1)
			this.stamina = 0.0
			
		this.animationModel.ChangeState("knockout");
		this.CancelAttack();
		
		if (this.landing)
		{
			//this.knockoutSFX.Play(1.0);
			
			if (lives <= 0 && this === player && playerStack.length === 0)
			{
				entityFrameskip = 1;
			}
		}
		
		if (this.health <= 0 && this.stateFrames > 90)
		{
			if (lives > 0 || this !== player)
			{
				this.Die();
				this.ReleaseOrbs();
				var deathanimation = new EffectAnimation(this.deathAnim, this, false);
				//deathanimation.spriteCenterX = 170;
				//deathanimation.spriteCenterY = 312;
				deathanimation.velZ = 0;
				level.entities.AddEffect(deathanimation);
			
				this.attack = this.deathAOEAttack;
				this.attack.Attack();
			}
			else if (this.stateFrames > 30)
			{
				this.Die();
				this.ReleaseOrbs();
			}
		}
		
		if (this.stamina >= 1.0)
		{
			this.ChangeState(States.GetUp);
			this.invincibilityFrames = 90;
		}
	}
	else if (this.state === States.Thrown)
	{
		this.animationModel.ChangeState("thrown");
		this.CancelAttack();
		
		if (this.landing)
		{
			//this.knockoutGroundHitSFX.Play(1.0);
		}
		
		if (this.stamina >= 1.0)
		{
			if (this.health <= 0)
			{
				this.Die();
				this.ReleaseOrbs();
				var deathanimation = new EffectAnimation(this.deathAnim, null, false);
				//deathanimation.spriteCenterX = 170;
				//deathanimation.spriteCenterY = 312;
				level.entities.AddEffect(deathanimation);
			}
			else
			{
				this.ChangeState(States.GetUp);
				this.invincibilityFrames = 90;
			}
		}
	}
	else if (this.state === States.GetUp)
	{
		this.invincibilityFrames = 90;
		this.animationModel.ChangeState("getup");
		if (this.animationModel.AnimationIsComplete("getup"))
			this.ChangeState(States.Walk);
	}
	else if (this.state === States.Grab)
	{
		this.orderBonus = -30;
		if (this.grabAttack.connected && this.captive === null && this.grabAttack.firstHitEntity !== null)
		{
			var closest = this.GetGrabCandidate();
			this.grabAttack.firstHitEntity = closest;
			if (closest !== null)
			{
				var attemptedCaptive = this.grabAttack.firstHitEntity.Capture(this);
				if (attemptedCaptive !== null)
				{
					this.captive = attemptedCaptive;
					this.heftSFX.Play(1.0);
				}
			}
		}
		
		if (this.captive !== null && this.stateFrames > 20)
		{
			this.captive.posX = crawlValue(this.captive.posX, this.posX + (this.grabX + this.captive.grabAdjustX) * this.facing, 35.0);
			this.captive.posY = crawlValue(this.captive.posY,this.posY + this.grabY + this.captive.grabAdjustY,35.0);
			this.captive.posZ = crawlValue(this.captive.posZ, this.posZ + this.grabZ + this.captive.grabAdjustZ, 35.0);
			this.captive.facing = -this.facing;
		}
		
		if (this.stateFrames > 17 && this.captive === null)
		{
			this.ChangeState(States.GrabFail);
			this.grabFailSFX.Play(1.0);
		}
		
		// Check if we have a captive. If so, take them captive
		if (this.stateFrames === 30 && this.captive !== null)
		{
			this.ChangeState(States.Drag);
		}
		
	}
	else if (this.state === States.Drag)
	{
		this.lastWalkState = this.state;
		
		this.captive.posX = this.posX + (this.grabX  + this.captive.grabAdjustX) * this.facing;
		this.captive.posY = this.posY + this.grabY + this.captive.grabAdjustY;
		this.captive.posZ = this.posZ + this.grabZ  + this.captive.grabAdjustZ;
		this.captive.facing = -this.facing;
			
		if (mag < 2.6 && !this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
		{
			if (this.drunkTimer > 0)
				this.animationModel.ChangeState("drunkdragIdle");
			else
				this.animationModel.ChangeState("dragIdle");
		}
		else
		{
			if (this.drunkTimer > 0)
				this.animationModel.ChangeState("drunkdrag");
			else
				this.animationModel.ChangeState("drag");
			
		}
		
		if ((this.animationModel.state == "drag" || this.animationModel.state == "drunkdrag") && this.animationModel.GetLastFrameWasTransition())
		{
			if (this.animationModel.GetLastFrameIndex() == 0)
				this.footstep_walk1.Play(1.0);
			else if (this.animationModel.GetLastFrameIndex() == 4)
				this.footstep_walk2.Play(1.0);
		}
	
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		if (this.controller.grabDeactivate()  || (this.captive.knockoutable && this.captive.health === 0))
		{
			if (!this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
				this.ChangeState(States.Release);
			else if (!this.captive.throwable)
				this.ChangeState(States.Release);
			else
				this.ChangeState(States.Throw);
		}
		
		if ( this.stateFrames > 10 && this.controller.punch )
		{
			this.ChangeState(States.CaptivePunch);
		}
		if ( this.stateFrames > 10 && this.controller.smoke && this.captive.kissable )
		{
			this.ChangeState(States.SmokeKiss);
		}
	}
	else if (this.state === States.GrabFail)
	{
		this.animationModel.ChangeState("grabfail");
		if (this.animationModel.animations["grabfail"].mainAnimation.done)
			this.ChangeState(States.Walk);
	}
	else if (this.state === States.Release)
	{
		this.animationModel.ChangeState("release");

		if (this.captive !== null && this.stateFrames === 3)
		{
			this.captive.Release(this);
			this.captive = null;
		}
		if (this.stateFrames === 20)
			this.ChangeState(States.Walk);
	}
	else if (this.state === States.Throw)
	{
		this.animationModel.ChangeState("throw");
		if (this.stateFrames === 10)
			this.throwSFX.Play(1.3);
			
		if (this.stateFrames < 26)
		{
			this.captive.posX = crawlValue(this.captive.posX, this.posX + 0 * this.facing, 5);
			this.captive.posY = crawlValue(this.captive.posY,this.posY,5);
			this.captive.posZ = crawlValue(this.captive.posZ, this.posZ + 350, 40);
			this.captive.facing = -this.facing;
			this.captive.prepareForThrow = true;
		}
		else if (this.stateFrames === 26)
		{
			// Release the captive
			this.captive.Release(this);
			
			// Knock them out and set stamina to 0
			this.captive.stamina = 0;
			this.captive.ChangeState(States.Thrown);
			
			// Throw them
			this.captive.velX = 50 * this.facing; //30 * this.facing;
			this.captive.velY = 0;
			this.captive.velZ = -1;  //18;
			
			// Attach a new throw attack
			var throwAttack = new Attack(this);
			throwAttack.positionOwner = this.captive;	// This attack is attached to the entity being thrown
			throwAttack.damageDealt = 15;
			throwAttack.staminaDrained = 1.0;
			//throwAttack.attackbox.SetBounds(-150,-30,0,30);
			throwAttack.attackbox = this.captive.hitRect.Copy();
			throwAttack.zHeight = -60;
			throwAttack.visualContactX = -150;
			throwAttack.visualContactZ = 0;
			throwAttack.alliance = 0;
			throwAttack.connectWithOwner = false;
			throwAttack.warmupframes = 5;
			throwAttack.attackFrames = 1;
			throwAttack.remainActiveUntil = 3;		// 3 = first hit or ground
			throwAttack.Attack();
			
			// Clean up the captive reference
			this.captive = null;
		}
		else if (this.stateFrames > 30*2)
		{
			this.ChangeState(States.Walk);
		}
	}
	else if (this.state === States.CaptivePunch)
	{
		if (this.captive !== null)
		{
			this.captive.posX = this.posX + (this.grabX + this.captive.grabAdjustX) * this.facing;
			this.captive.posY = this.posY + this.grabY + this.captive.grabAdjustY;
			this.captive.posZ = this.posZ + this.grabZ + this.captive.grabAdjustZ;
			this.captive.facing = -this.facing;
		}
		
		this.animationModel.ChangeState("captivepunch");
		// Hitsparks on animation frames 4, 9, 14, and 19 out of 25
		// that is state frames 21, 47, 74, 100
		if (this.stateFrames === 21 || this.stateFrames === 47 || this.stateFrames === 74)
		{
			var sparks = new HitSpark(this, 150*this.facing,200);
			sparks.scale = 4.0;
			level.entities.AddEffect(sparks);
			this.captive.Hit(this.lightPunchAttack, true);
		}
		else if (this.stateFrames === 100)
		{
			// Release the captive
			this.captive.velX = 10 * this.facing;
			this.captive.velY = 0;
			this.captive.velZ = 15;
			//this.captive.posX += 30*this.facing;
			this.captive.Release(this);
			
			// Knock them out and set stamina to 0
			this.captive.Hit(this.tackleAttack, true);
			
			// Clean up the captive reference
			this.captive = null;
			
			// Generate hitsparks
			var sparks = new HitSpark(this, 150*this.facing,300);
			sparks.scale = 4.0;
			level.entities.AddEffect(sparks);
		}
		if (this.stateFrames < 85 && !this.controller.punch)
		{
			this.ChangeState(States.Release);
		}
			
		if (this.stateFrames > 132)
			this.ChangeState(States.Walk);
			
	}
	else if (this.state === States.SmokeKiss)
	{
		if (this.captive !== null)
		{
			this.captive.posX = this.posX + (165+this.captive.grabAdjustX) * this.facing;
			this.captive.posY = this.posY+this.captive.grabAdjustY;
			this.captive.posZ = this.posZ+this.captive.grabAdjustZ;
			this.captive.facing = -this.facing;
		}
		
		this.animationModel.ChangeState("smokekissjoe");
		
		if (this.stateFrames === 1)
		{
			var puff = new SmokeKissPuff(this,25,110);
			level.entities.AddEffect(puff);
			this.puffAndDragSFX.Play(0.5);
		}
		
		if (this.stateFrames === 80)
		{
			if (this.drunkTimer > 0)
				this.smokeKissDrunkSFX.Play(2.0);
			else
				this.smokeKissSFX.Play(2.0);

		}
		
		if (this.stateFrames < 156)
		{
			this.captive.ChangeState(States.CaptiveSmokeKiss);
		}

		if (this.stateFrames === 170)
		{			
			// Hit the captive with the effects of the smoke kiss
			this.captive.Hit(this.smokeKissAttack, true);
			
			// Always update positon BEFORE releasing the captive so the release function
			// can do its collision detection magic
			this.captive.posX += 150*this.facing;
			this.captive.posZ += 5;
			this.captive.velX = 10 * this.facing;
			this.captive.velY = 0;
			this.captive.velZ = 10;
			
			// Release the captive
			this.captive.Release(this);
			
			// If the captive is "dead" now, transition to the corruption transformation
			if (this.captive.health === 0)
			{
				this.captive.ChangeState(States.CorruptionTransform);
			}
			// If the captive is already alliance flipped, just drop them
			else if (this.captive.recruited)
			{
				this.captive.ChangeState(States.Walk);
				this.captive.recruit(this);
			}
			// If they are alive and unflipped, do a temporary alliance flip
			else
			{
				this.captive.ChangeState(States.FallAfterSmokeKiss);
				this.captive.recruit(this);
			}
			
			// Clean up the captive reference
			this.captive = null;
		}

		if (this.stateFrames > 180)
			this.ChangeState(States.Walk);
			
	}
	else if (this.state === States.Captive)
	{
		if (this.prepareForThrow)
			this.animationModel.ChangeState("thrown");
		else
			this.animationModel.ChangeState("captive");
	}
	else if (this.state === States.FallAfterSmokeKiss)
	{
		this.ChangeState(States.Walk);
	}
	else if (this.state === States.CorruptionTransform)
	{
		this.stamina = 0;
		this.ChangeState(States.KnockedOut);
	}
	else if (this.state === States.CaptiveHitStun)
	{
		// Force a reset
		if (this.stateFrames === 1)
			this.animationModel.animations["hitstun"].mainAnimation.Reset();
		this.animationModel.ChangeState("hitstun");
		if (this.stateFrames === 6)
			this.ChangeState(States.Captive);
	}
	else if (this.state === States.PrepareSexTop)
	{
		// Transform for the animation
		this.animationModel.ChangeState(this.prepareSexAnim);
		
		if (this.stateFrames === 1 && this.sexSFX !== null)
		{
			this.sexSFXSource = this.sexSFX.Play(1.0,this.sexSFXDelay);
		}
		
		if (this.animationModel.AnimationIsComplete(this.prepareSexAnim))
		{
			this.sexPrepareX = this.posX;
			this.sexPrepareY = this.posY;
			this.sexPrepareZ = this.posZ;
			this.ChangeState(States.BeforeSexTop);
		}
			
		// Drain the sex energy meter and tell everyone onscreen to start watching sex
		if (this.stateFrames === 1)
		{			
			if (this.drunkTimer > 0)
				this.sexMeter = Math.ceil(this.maxSexMeter / 2.0);
			else
				this.sexMeter = 0;
			
			for (var i = 0; i < entitiesOnScreen.length; i++)
			{
				if (!IsCaptive(entitiesOnScreen[i].state) && !entitiesOnScreen[i].recruited)
				{	
					var dur = this.animationModel.GetDurationInFrames(this.prepareSexAnim) + this.animationModel.GetDurationInFrames(this.beforeSexAnim) + this.animationModel.GetDurationInFrames(this.sexAnim) + this.animationModel.GetDurationInFrames(this.afterSexAnim);
					entitiesOnScreen[i].WatchSex(dur);
				}
			}
		}
			
		// Force the captive to face the right way for sex
		this.captive.facing = -this.facing;
	}
	else if (this.state === States.BeforeSexTop)
	{
		// Walk over to the target
		this.animationModel.ChangeState(this.beforeSexAnim);
		if (this.animationModel.AnimationIsComplete(this.beforeSexAnim))
		{
			if (this.captive instanceof Joe4 && this.captive.sexType === 0)
			{
				var smokeClone = new EffectAnimation(this.smokeCloneAnimation, this, true);
				smokeClone.orderBonus = 160;
				smokeClone.orderBonusAdjust = true;
				smokeClone.orderBonusEnd = -40;
				level.entities.AddEffect(smokeClone);
			}
			
			if (this.captive instanceof Joe5 && this.captive.sexType === 0)
			{
				this.ChangeState(States.FinishBoss);
			}
			else
			{
				this.ChangeState(States.CaptiveSexTop);
				if (this.captive !== null)
					this.captive.ChangeState(States.CaptiveSexBottom);
			}
		}
					
		if (this.captive !== null)
		{
			var pos = this.animationModel.GetState().mainAnimation.position;
			this.posX = linearRemap(pos,0,1,this.sexPrepareX,this.captive.posX+this.captiveOffsetX*this.captive.facing);
			this.posY = linearRemap(pos,0,1,this.sexPrepareY,this.captive.posY+this.captiveOffsetY);
			this.posZ = linearRemap(pos,0,1,this.sexPrepareZ,this.captive.posZ+this.captiveOffsetZ);
		}
	}
	else if (this.state === States.CaptiveSexTop)
	{
		// Start the sex animation
		this.animationModel.ChangeState(this.sexAnim);
		
		if (this.captive instanceof Joe5 && this.captive.sexType === 1 )	
		{
			// Game ending fade out
			if (this.stateFrames === 1700)
			{
				this.lightFlash = new GlobalLight();
				this.lightFlash.lightColor = "#C8BDCA";
				this.lightFlash.alpha = 0;
				overlays.push(this.lightFlash);
			}
			
			if (this.stateFrames > 1700 && this.stateFrames <= 1900)
				this.lightFlash.alpha = linearRemap(this.stateFrames, 1700, 1900, 0.0, 1.0);
			
			if (this.animationModel.AnimationIsComplete(this.sexAnim))
			{
				var bartender = this;
				this.ChangeState(States.Walk);
				loadLevelFromURL("level6", true, function(){
					bartender.lightFlash.FadeOutAndDie(90);
					bartender.alpha = 0;
					bartender.alphaTimer = 120;
					bartender.lightFlash = null;
					});
			}
			
		}
		// If the animation is complete, go ahead and release the captive and exit this state
		else if (this.animationModel.AnimationIsComplete(this.sexAnim))
		{
			if (this.captive instanceof Joe4 && this.captive.sexType === 0)
			{
				var smokeClone = new EffectAnimation(this.smokeCloneAfterAnimation, this, false);
				smokeClone.orderBonus = -40;
				level.entities.AddEffect(smokeClone);
			}
			
			//if (this.sexSFX !== null && this.sexSFXSource !== null)
			//	this.sexSFXSource.stop(0);
			
			// Unleash the sex AOE attack to give enemies boners or corrupt them
			//this.sexAOEAttack();
			this.ChangeState(States.AfterSexTop);
			this.captive.Release(this);
			this.captive.fucked = true;
			this.captive = null;
		}
	}
	else if (this.state === States.AfterSexTop)
	{
		// Push back and transform back
		this.animationModel.ChangeState(this.afterSexAnim);
		if (this.animationModel.AnimationIsComplete(this.afterSexAnim))
		{
			this.ChangeState(States.Walk);
			
			// Tell enemies onscreen they can stop watching the sex
			for (var i = 0; i < entitiesOnScreen.length; i++)
			{
				if (!IsCaptive(entitiesOnScreen[i].state) && !entitiesOnScreen[i].recruited && entitiesOnScreen[i].watchingSex)
				{	
					if (entitiesOnScreen[i] instanceof Joe3 || entitiesOnScreen[i] instanceof Joe4)
						entitiesOnScreen[i].WatchSex(90 + Math.round(Math.random()*15));
					else
						entitiesOnScreen[i].WatchSex(30 + Math.round(Math.random()*15));
				}
			}
		}
		
		// Perform a pushback at the right time
		if (this.stateFrames === 10)
		{
			this.velX -= 10 * this.facing;
		}
	}
	else if (this.state === States.Snared)
	{
		this.animationModel.ChangeState("snarehitstun");
		
		if (this.controller.punchActivate() && this.animationModel.animations["snarehitstun"].mainAnimation.done)
		{
			this.stateFrames += 10;
			this.animationModel.animations["snarehitstun"].mainAnimation.Reset();
		}
		
		if (this.stateFrames >= 120)
			this.ChangeState(States.Walk);	
	}
	
	else if (this.state === States.FinishBoss)
	{
		this.animationModel.ChangeState("finishboss");
		
		if (this.captive !== null)
		{
			this.captive.Release(this);
			this.captive.Die();
			this.captive = null;
		}
		
		if (this.animationModel.AnimationIsComplete("finishboss"))
		{
			// Spawn the defeated Joe5
			var defeatedJoe5 = new Joe5();
			defeatedJoe5.ai = null; // make sure it's braindead
			defeatedJoe5.health = 0;
			defeatedJoe5.ChangeState(States.Thrown);
			defeatedJoe5.posX = this.posX + this.facing*160;
			defeatedJoe5.posY = this.posY-30;
			defeatedJoe5.posZ = 1;
			defeatedJoe5.velX = this.facing * 12;
			defeatedJoe5.velZ = 20;
			defeatedJoe5.facing = -this.facing;
			
			level.entities.AddEntity(defeatedJoe5);
			
			this.ChangeState(States.Transforming);
		}
	}
	else if (this.state === States.Transforming)
	{
		this.animationModel.ChangeState("transforming");
		
		if (this.animationModel.AnimationIsComplete("transforming"))
			this.ChangeState(States.TransformedWalk);
	}
	else if (this.state === States.TransformedWalk)
	{
		if (mag < 2.6 && !this.controller.up && !this.controller.down && !this.controller.left && !this.controller.right)
			this.animationModel.ChangeState("transformidle");
		else
			this.animationModel.ChangeState("transformwalk");
			
		// Move the character based on controller input
		this.ProcessDirectionalInput();
		
		// Change to Fuck or Grab State
		if (this.controller.grabActivate())
		{
			var fuckCandidate = this.GetFuckCandidate();
			if (fuckCandidate !== null)
			{
				var attemptedCaptive = fuckCandidate.Capture(this);
				if (attemptedCaptive !== null)
				{
					this.SetupSexAnimation(attemptedCaptive);
					this.captive = attemptedCaptive;
					this.ChangeState(States.PrepareSexTop);
				}
			}
		}
	}
	else if (this.state === States.CutsceneWalk)
	{
		if (this.cutsceneWalkX === this.posX && this.cutsceneWalkY === this.posY)
			this.animationModel.ChangeState("idle");
		else
			this.animationModel.ChangeState("cutscenewalk");
			
		this.posX = crawlValue(this.posX, this.cutsceneWalkX, 8);
		this.posY = crawlValue(this.posY, this.cutsceneWalkY, 8);
	}
	
	// If for some reason we have a captive in a state that we should not, release it.
	if (this.captive !== null && this.state !== States.Grab && this.state !== States.Drag && 
		this.state !== States.Throw && this.state !== States.CaptivePunch && this.state !== States.CaptiveFinish && 
		this.state !== States.SmokeKiss && this.state !== States.CaptiveSexTop && this.state !== States.AfterSexTop && 
		this.state !== States.PrepareSexTop && this.state !== States.BeforeSexTop && this.state !== States.FinishBoss && this.state !== States.Release)
	{
		this.captive.Release(this);
		this.captive = null;
	}
	
	//// If for some reason we have a captive in a state that we should not, release it.
	//if (this.captive !== null && this.captive instanceof Joe4 && this.captive.state === States.BasicAttack)
	//{
	//	this.captive.Release(this);
	//	this.captive = null;
	//}
};

Bartender.prototype.sexAOEAttack = function()
{
	var e = level.entities.GetEntitiesInRadius(this, 800);
	for (var i=0; i < e.length; i++)
	{
		if ("ChangeState" in e[i])	// only walking entites have changestate
		{
			if (e[i].state === States.Corrupt && e[i] !== this && e[i] !== this.captive)
			{
				e[i].stateFrames = 10000;
			}
			else if (!IsInvulnerable(e[i].state) && e[i] !== this && e[i] !== this.captive)
			{
				// Hit the captive with the effects of the smoke kiss
				e[i].Hit(this.fuckAOEAttack, true);

				// If the captive is "dead" now, transition to the corruption transformation
				if (e[i].health === 0)
				{
					e[i].ChangeState(States.CorruptionTransform);
				}
				else
				{
					e[i].ChangeState(States.FallAfterSmokeKiss);
				}
			}
		}
	}
};

// All the animation frames associated with the bartender.
GlobalResourceLoader.AddImageResource("sheet_Bartender_Attack","images/bartender/sheet_Bartender_Attack.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Attack_Drunk","images/bartender/sheet_Bartender_Attack_Drunk.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Basic","images/bartender/sheet_Bartender_Basic.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Basic_Drunk","images/bartender/sheet_Bartender_Basic_Drunk.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Drunk","images/bartender/sheet_Bartender_Drunk.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Dash","images/bartender/sheet_Bartender_Dash.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_DeathSmoke","images/bartender/sheet_Bartender_DeathSmoke.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_DesperationSmoke","images/bartender/sheet_Bartender_DesperationSmoke.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_smokedescent","images/bartender/sheet_Bartender_smokedescent.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_SmokeRing","images/bartender/sheet_Bartender_SmokeRing.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_WithCaptive","images/bartender/sheet_Bartender_WithCaptive.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_WithCaptive_Drunk","images/bartender/sheet_Bartender_WithCaptive_Drunk.txt");

GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe1Sex_Footjob","images/bartender/sheet_Bartender_Joe1Sex_Footjob.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe1Sex_Anal","images/bartender/sheet_Bartender_Joe1Sex_Anal.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe2Sex_Blowjob","images/bartender/sheet_Bartender_Joe2Sex_Blowjob.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe3Sex_Anal","images/bartender/sheet_Bartender_Joe3Sex_Anal.txt");

GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe4Sex_Spitroast_Joe4","images/bartender/sheet_Bartender_Joe4Sex_Spitroast_Joe4.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe4Sex_Spitroast_Smoke","images/bartender/sheet_Bartender_Joe4Sex_Spitroast_Smoke.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe4Sex_Spitroast","images/bartender/sheet_Bartender_Joe4Sex_Spitroast.txt");

GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe1DrunkSex_Blowjob","images/bartender/sheet_Bartender_Joe1DrunkSex_Blowjob.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe2DrunkSex_Rimjob","images/bartender/sheet_Bartender_Joe2DrunkSex_Rimjob.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe3DrunkSex_Bottom","images/bartender/sheet_Bartender_Joe3DrunkSex_Bottom.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe4DrunkSex_Cowboy","images/bartender/sheet_Bartender_Joe4DrunkSex_Cowboy.txt");

GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe5Sex_Kiss","images/bartender/sheet_Bartender_Joe5Sex_Kiss.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe5Sex_Anal","images/bartender/sheet_Bartender_Joe5Sex_Anal.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe5Sex_Transform","images/bartender/sheet_Bartender_Joe5Sex_Transform.txt");
GlobalResourceLoader.AddImageResource("sheet_Bartender_Joe5Sex_Finale","images/bartender/sheet_Bartender_Joe5Sex_Finale.txt");


Bartender.prototype.animationSetup = function()
{
	this.deathAnim = new Animation(this);
	this.deathAnim.AddSequentialFrames("bartender/death{0}",1,27);	
	this.deathAnim.blendMode = "lighter";
	this.deathAnim.inheritFacing = 1;		
	this.deathAnim.SetDurationInSeconds(2.5);
	
	this.smokedescent = new Animation(this);
	this.smokedescent.HoldFrame("bartender/smokedescent1",12);
	this.smokedescent.AddSequentialFrames("bartender/smokedescent{0}",1,32);	
	this.smokedescent.blendMode = "lighter";
	this.smokedescent.inheritFacing = 1;		
	this.smokedescent.SetDurationInSeconds(3.5);
	
	// Define the idle animation
	var idleAnim = new Animation(this);
	idleAnim.repeat = 1;						// This animation loops
	idleAnim.inheritFacing = 1;					// It inherits the player's facing property
	idleAnim.sendPosition = false;
	idleAnim.AddSequentialFrames("bartender/idle{0}",1,8);		// All the frames and their timing info
	idleAnim.SetDurationInSeconds(1.0);				// Set how long one loop takes (in seconds)
	
	// Add the idle animation and all its transitions to the idle animation state
	var idleState = new AnimationState();
	idleState.SetMainAnimation(idleAnim);
	
	// Define a transition from walk to idle
	var walkToIdle = new Animation(this);
	walkToIdle.repeat = 3;
	walkToIdle.inheritFacing = 1;					// It inherits the player's facing property
	walkToIdle.matchPosition = true;
	walkToIdle.AddFrame("bartender/walk1");
	walkToIdle.SetDurationInSeconds(0.2);
	idleState.AddTransitionAnimation("walk", walkToIdle); 
	
	// Add all the animation states to the animations collection
	this.animationModel.AddState("idle",idleState);
	
	// Define the walk animation
	var walkAnim = new Animation(this);
	walkAnim.repeat = 1;						// This animation loops
	walkAnim.dynamicRate = 1;					// This animation moves faster with player speed
	walkAnim.inheritFacing = 1;					// It inherits the player's facing property
	walkAnim.matchPosition = true;
	walkAnim.AddSequentialFrames("bartender/walk{0}",1,8);		// All the frames and their timing info
	walkAnim.SetDurationInSeconds(6.4);
	var walkState = new AnimationState();
	walkState.SetMainAnimation(walkAnim);
	this.animationModel.AddState("walk", walkState);
	
	// Define the walk animation
	var walkAnim = new Animation(this);
	walkAnim.repeat = 1;						// This animation loops
	walkAnim.dynamicRate = 0;					// This animation moves faster with player speed
	walkAnim.inheritFacing = 1;					// It inherits the player's facing property
	walkAnim.matchPosition = true;
	walkAnim.AddSequentialFrames("bartender/walk{0}",1,8);		// All the frames and their timing info
	walkAnim.SetDurationInSeconds(0.8);
	var walkState = new AnimationState();
	walkState.SetMainAnimation(walkAnim);
	this.animationModel.AddState("cutscenewalk", walkState);
	
	// Define the walk animation
	var runAnim = new Animation(this);
	runAnim.repeat = 1;							// This animation loops
	runAnim.dynamicRate = 1;					// This animation moves faster with player speed
	runAnim.inheritFacing = 1;					// It inherits the player's facing property
	runAnim.matchPosition = true;
	runAnim.AddSequentialFrames("bartender/run{0}",1,8);		// All the frames and their timing info
	runAnim.SetDurationInSeconds(7.6);
	var runState = new AnimationState();
	runState.SetMainAnimation(runAnim);
	this.animationModel.AddState("run",runState);
	
	// Define the jump animation
	var jumpAnim = new Animation(this);
	jumpAnim.repeat = 0;						// This animation is one-shot
	jumpAnim.inheritFacing = 1;					// It inherits the player's facing property
	jumpAnim.matchPosition = false;
	jumpAnim.AddFrame("bartender/jump1");		// All the frames and their timing info
	jumpAnim.AddFrame("bartender/jump2");
	jumpAnim.AddFrame("bartender/jump3");
	jumpAnim.AddFrame("bartender/jump4");
	jumpAnim.SetPosition(0,  0.00 / 4.0);
	jumpAnim.SetPosition(1,  0.66 / 4.0);
	jumpAnim.SetPosition(2,  1.33 / 4.0);
	jumpAnim.SetPosition(3,  2.00 / 4.0);
	jumpAnim.SetDurationInSeconds(0.5);
	var jumpState = new AnimationState();
	jumpState.SetMainAnimation(jumpAnim);
	this.animationModel.AddState("jump",jumpState);
	
	// Define the fall animation (just one frame)
	var fallAnim = new Animation(this);
	fallAnim.repeat = 0;
	fallAnim.inheritFacing = 1;	
	fallAnim.matchPosition = 0;
	fallAnim.AddFrame("bartender/jump1",  1.0);
	
	// Define the jump to fall animation
	var jumpToFallAnim = new Animation(this);
	jumpToFallAnim.repeat = 0;						    // This animation iis one-shot
	jumpToFallAnim.inheritFacing = 1;					// It inherits the player's facing property
	jumpToFallAnim.matchPosition = 2;
	jumpToFallAnim.AddFrame("bartender/jump4");		// All the frames and their timing info
	jumpToFallAnim.AddFrame("bartender/jump3");
	jumpToFallAnim.AddFrame("bartender/jump2");
	jumpToFallAnim.AddFrame("bartender/jump1");
	jumpToFallAnim.SetPosition(0,  1.33 / 4.0);
	jumpToFallAnim.SetPosition(1,  2.00 / 4.0);
	jumpToFallAnim.SetPosition(2,  2.66 / 4.0);
	jumpToFallAnim.SetPosition(3,  3.33 / 4.0);
	
	jumpToFallAnim.SetDurationInSeconds(0.3);
	
	var fallState = new AnimationState();
	fallState.SetMainAnimation(fallAnim);
	fallState.AddTransitionAnimation("jump", jumpToFallAnim); 
	this.animationModel.AddState("fall",fallState);
	
	// Define the light punch animation
	var lightPunchAnim = new Animation(this);
	lightPunchAnim.repeat = 0;							// This animation is one-shot
	lightPunchAnim.inheritFacing = 1;					// It inherits the player's facing property
	lightPunchAnim.matchPosition = false;
	lightPunchAnim.AddFrame("bartender/lightpunch1");		// All the frames and their timing info
	lightPunchAnim.AddFrame("bartender/lightpunch2");
	lightPunchAnim.AddFrame("bartender/lightpunch3");
	lightPunchAnim.SetDurationInSeconds(0.18);
	var lightPunchState = new AnimationState();
	lightPunchState.SetMainAnimation(lightPunchAnim);
	this.animationModel.AddState("lightpunch",lightPunchState);
	
	// Define the kick animation
	var airKickAnim = new Animation(this);
	airKickAnim.repeat = 0;							// This animation is one-shot
	airKickAnim.inheritFacing = 1;					// It inherits the player's facing property
	airKickAnim.matchPosition = false;
	airKickAnim.AddSequentialFrames("bartender/flyingkick{0}",1,6);		// All the frames and their timing info
	airKickAnim.SetDurationInSeconds(0.50);
	var airKickState = new AnimationState();
	airKickState.SetMainAnimation(airKickAnim);
	this.animationModel.AddState("airkick",airKickState);
	
	// Define the kick animation
	var kickAnim = new Animation(this);
	kickAnim.repeat = 0;							// This animation is one-shot
	kickAnim.inheritFacing = 1;					// It inherits the player's facing property
	kickAnim.matchPosition = false;
	kickAnim.AddFrame("bartender/kick1");		// All the frames and their timing info
	kickAnim.AddFrame("bartender/kick2");
	kickAnim.AddFrame("bartender/kick3");
	kickAnim.AddFrame("bartender/kick4");		// All the frames and their timing info
	kickAnim.AddFrame("bartender/kick5");
	kickAnim.SetDurationInSeconds(0.30);
	var kickState = new AnimationState();
	kickState.SetMainAnimation(kickAnim);
	this.animationModel.AddState("kick",kickState);
	
	// Define the hitstun animation
	var hitStunAnim = new Animation(this);
	hitStunAnim.repeat = 0;							// This animation is one-shot
	hitStunAnim.inheritFacing = 1;					// It inherits the player's facing property
	hitStunAnim.matchPosition = false;
	hitStunAnim.AddSequentialFrames("bartender/hitstun{0}", 1, 4);		// All the frames and their timing info
	hitStunAnim.SetDurationInSeconds(0.18);
	var hitStunState = new AnimationState();
	hitStunState.SetMainAnimation(hitStunAnim);
	this.animationModel.AddState("hitstun",hitStunState);
	
	// Define the hitstun animation
	var animation = new Animation(this);
	animation.repeat = 0;							// This animation is one-shot
	animation.inheritFacing = 1;					// It inherits the player's facing property
	animation.AddSequentialFrames("bartender/hitstun{0}", 4, 1);		// All the frames and their timing info
	animation.SetDurationInSeconds(0.3);
	var hitStunState = new AnimationState();
	hitStunState.SetMainAnimation(animation);
	this.animationModel.AddState("snarehitstun",hitStunState);
	
	// Add hitstun as a transition back to idle to make snare releases look less janky
	idleState.AddTransitionAnimation("snarehitstun", hitStunAnim); 
	
	
	// Define the knockout animation
	var knockoutAnim = new Animation(this);
	knockoutAnim.repeat = 0;							// This animation is one-shot
	knockoutAnim.inheritFacing = 1;					// It inherits the player's facing property
	knockoutAnim.matchPosition = false;
	knockoutAnim.AddFrame("bartender/knockout1");		// All the frames and their timing info
	knockoutAnim.AddFrame("bartender/knockout2");
	knockoutAnim.AddFrame("bartender/knockout3");
	knockoutAnim.AddFrame("bartender/knockout4");
	knockoutAnim.AddFrame("bartender/knockout5");
	knockoutAnim.SetDurationInSeconds(0.4);
	var knockoutState = new AnimationState();
	knockoutState.SetMainAnimation(knockoutAnim);
	this.animationModel.AddState("knockout",knockoutState);
	
	// Define the thrown animation
	var thrownAnim = new Animation(this);
	thrownAnim.repeat = 0;							// This animation is one-shot
	thrownAnim.inheritFacing = 1;					// It inherits the player's facing property
	thrownAnim.matchPosition = false;
	thrownAnim.AddFrame("bartender/knockout3");
	thrownAnim.AddFrame("bartender/knockout4");
	thrownAnim.AddFrame("bartender/knockout5");
	thrownAnim.SetDurationInSeconds(0.4);
	var thrownState = new AnimationState();
	thrownState.SetMainAnimation(thrownAnim);
	this.animationModel.AddState("thrown",thrownState);
	
	// Define the get up animation
	var getupAnim = new Animation(this);
	getupAnim.repeat = 0;							// This animation is one-shot
	getupAnim.inheritFacing = 1;					// It inherits the player's facing property
	getupAnim.matchPosition = false;
	getupAnim.AddFrame("bartender/getup1");		// All the frames and their timing info
	getupAnim.AddFrame("bartender/getup2");
	getupAnim.AddFrame("bartender/getup3");
	getupAnim.AddFrame("bartender/getup4");
	getupAnim.AddFrame("bartender/getup5");
	getupAnim.AddFrame("bartender/getup6");
	getupAnim.SetDurationInSeconds(0.5);
	var getupState = new AnimationState();
	getupState.SetMainAnimation(getupAnim);
	this.animationModel.AddState("getup",getupState);
	
	var tackleAnim = new Animation(this);
	tackleAnim.repeat = 0;							// This animation is one-shot
	tackleAnim.inheritFacing = 1;					// It inherits the player's facing property
	tackleAnim.matchPosition = false;
	tackleAnim.AddFrame("bartender/tackle1");		// All the frames and their timing info
	tackleAnim.AddFrame("bartender/tackle3");
	tackleAnim.AddFrame("bartender/tackle4");
	tackleAnim.AddFrame("bartender/tackle5");
	tackleAnim.AddFrame("bartender/tackle6");
	tackleAnim.SetDurationInSeconds(0.5);
	var tackleState = new AnimationState();
	tackleState.SetMainAnimation(tackleAnim);
	this.animationModel.AddState("tackle",tackleState);
	
	// Define the smoke-walk animation
	var smokeAttackAnim = new Animation(this);
	smokeAttackAnim.repeat = 2;						// This animation bounces
	smokeAttackAnim.inheritFacing = 1;
	smokeAttackAnim.AddFrame("bartender/smokecharge1");		// All the frames and their timing info
	smokeAttackAnim.AddFrame("bartender/smokecharge2");
	smokeAttackAnim.AddFrame("bartender/smokecharge3");
	smokeAttackAnim.AddFrame("bartender/smokecharge4");
	smokeAttackAnim.AddFrame("bartender/smokecharge5");
	smokeAttackAnim.AddFrame("bartender/smokecharge6");
	smokeAttackAnim.SetDurationInSeconds(0.8);
	smokeAttackAnim.loopStartPosition = (2.0/6.0);	// When bouncing, bounce between 3 and 6
	
	var smokeWalkAnim = new Animation(this);
	smokeWalkAnim.repeat = 1;						// This animation loops
	smokeWalkAnim.dynamicRate = 1;					// This animation moves faster with player speed
	smokeWalkAnim.inheritFacing = 1;					// It inherits the player's facing property
	smokeWalkAnim.matchPosition = true;
	smokeWalkAnim.AddFrame("bartender/smokewalk1",0,0);					// All the frames and their timing info
	smokeWalkAnim.AddFrame("bartender/smokewalk2",-1,-1);
	smokeWalkAnim.AddFrame("bartender/smokewalk3",-2,0);
	smokeWalkAnim.AddFrame("bartender/smokewalk4",-2,0);
	smokeWalkAnim.AddFrame("bartender/smokewalk5",-2,1);
	smokeWalkAnim.AddFrame("bartender/smokewalk6",-1,1);
	smokeWalkAnim.AddFrame("bartender/smokewalk7",2,2);
	smokeWalkAnim.AddFrame("bartender/smokewalk8",0,3);
	smokeWalkAnim.SetDurationInSeconds(6.4);
	var smokeWalkState = new AnimationState();
	smokeWalkState.SetMainAnimation(smokeWalkAnim);
	smokeWalkState.AddDecoratorAnimation(smokeAttackAnim);
	this.animationModel.AddState("smokewalk", smokeWalkState);
	
	var smokeIdleAnim = new Animation(this);
	smokeIdleAnim.repeat = 1;						// This animation loops
	smokeIdleAnim.dynamicRate = 1;					// This animation moves faster with player speed
	smokeIdleAnim.inheritFacing = 1;					// It inherits the player's facing property
	smokeIdleAnim.matchPosition = false;
	smokeIdleAnim.sendPosition = false;
	smokeIdleAnim.AddFrame("bartender/smokeidle1");
	smokeIdleAnim.SetDecoratorOffset(0,-8,3);
	smokeIdleAnim.SetDurationInSeconds(1.5);
	var smokeIdleState = new AnimationState();
	smokeIdleState.SetMainAnimation(smokeIdleAnim);
	smokeIdleState.AddDecoratorAnimation(smokeAttackAnim);
	this.animationModel.AddState("smokeidle", smokeIdleState);
	
	
		// Define the smoke-walk animation
	var smokeChargeFastAnim = new Animation(this);
	smokeChargeFastAnim.repeat = 0;						// This animation bounces
	smokeChargeFastAnim.inheritFacing = 1;
	// All the frames and their timing info
	smokeChargeFastAnim.AddFrame("bartender/smokecharge2");
	smokeChargeFastAnim.AddFrame("bartender/smokecharge3");
	smokeChargeFastAnim.AddFrame("bartender/smokecharge4");
	smokeChargeFastAnim.AddFrame("bartender/smokecharge5");
	smokeChargeFastAnim.AddFrame("bartender/smokecharge6");
	smokeChargeFastAnim.SetDurationInSeconds(0.333);
	
	var smokeChargeFastBaseAnim = new Animation(this);
	smokeChargeFastBaseAnim.repeat = 1;						// This animation loops
	smokeChargeFastBaseAnim.inheritFacing = 1;					// It inherits the player's facing property
	smokeChargeFastBaseAnim.matchPosition = false;
	smokeChargeFastBaseAnim.sendPosition = false;
	smokeChargeFastBaseAnim.AddFrame("bartender/smokeidle1");
	smokeChargeFastBaseAnim.SetDecoratorOffset(0,-8,3);
	smokeChargeFastBaseAnim.SetDurationInSeconds(1.5);
	var smokeChargeFastBaseState = new AnimationState();
	smokeChargeFastBaseState.SetMainAnimation(smokeChargeFastBaseAnim);
	smokeChargeFastBaseState.AddDecoratorAnimation(smokeChargeFastAnim);
	this.animationModel.AddState("smokechargefast", smokeChargeFastBaseState);
	
		// Define the smoke-smoking idle cancel animation
	var smokeAttackCancelAnim = new Animation(this);
	smokeAttackCancelAnim.repeat = 0;						// This animation bounces
	smokeAttackCancelAnim.inheritFacing = 1;
	smokeAttackCancelAnim.AddFrame("bartender/smokecharge3");		// All the frames and their timing info
	smokeAttackCancelAnim.AddFrame("bartender/smokecharge2");
	smokeAttackCancelAnim.AddFrame("bartender/smokecharge1");
	smokeAttackCancelAnim.SetDurationInSeconds(0.26);
	
	var smokeIdleCancelState = new AnimationState();
	smokeIdleCancelState.SetMainAnimation(smokeIdleAnim);
	smokeIdleCancelState.AddDecoratorAnimation(smokeAttackCancelAnim);
	this.animationModel.AddState("smokeidlecancel", smokeIdleCancelState);
	
	var smokeWalkCancelState = new AnimationState();
	smokeWalkCancelState.SetMainAnimation(smokeWalkAnim);
	smokeWalkCancelState.AddDecoratorAnimation(smokeAttackCancelAnim);
	this.animationModel.AddState("smokewalkcancel", smokeWalkCancelState);
	
	// Define the smoke-ring blow animation
	var smokeIdleBlowAnim = new Animation(this);
	smokeIdleBlowAnim.repeat = 0;						// This animation bounces
	smokeIdleBlowAnim.inheritFacing = 1;
	smokeIdleBlowAnim.AddSequentialFrames("bartender/smoke_idle_blow{0}",1,7);		// All the frames and their timing info
	smokeIdleBlowAnim.HoldFrame("bartender/smoke_idle_blow7",4)
	smokeIdleBlowAnim.AddFrame("bartender/smoke_idle_blow2")
	smokeIdleBlowAnim.AddFrame("bartender/smoke_idle_blow1")
	smokeIdleBlowAnim.AddFrame("bartender/smokecharge2");
	smokeIdleBlowAnim.SetDurationInSeconds(2.0);
	
	this.smokeRingAnim = new Animation(this);
	this.smokeRingAnim.AddSequentialFrames("bartender/smokering{0}",1,11)
	this.smokeRingAnim.SetDurationInSeconds(1.1);
	this.smokeRingAnim.inheritFacing = 1;
	this.smokeRingAnim.blendMode = "lighter";
	
	var smokeIdleBlowState = new AnimationState();
	smokeIdleBlowState.SetMainAnimation(smokeIdleAnim);
	smokeIdleBlowState.AddDecoratorAnimation(smokeIdleBlowAnim);
	this.animationModel.AddState("smokeidleblow", smokeIdleBlowState);
	
	// Define the smoke blow animation
	var smokeBlowAnim = new Animation(this);
	smokeBlowAnim.repeat = 0;
	smokeBlowAnim.inheritFacing = 1;
	smokeBlowAnim.AddFrame("bartender/smokeblow1");		// All the frames and their timing info
	smokeBlowAnim.AddFrame("bartender/smokeblow2");
	smokeBlowAnim.AddFrame("bartender/smokeblow3");
	smokeBlowAnim.AddFrame("bartender/smokeblow4");
	smokeBlowAnim.AddFrame("bartender/smokeblow5");
	smokeBlowAnim.AddFrame("bartender/smokeblow6");
	smokeBlowAnim.AddFrame("bartender/smokeblow6");
	smokeBlowAnim.AddFrame("bartender/smokeblow6");
	smokeBlowAnim.AddFrame("bartender/smokeblow6");
	smokeBlowAnim.AddFrame("bartender/smokeblow6");
	smokeBlowAnim.AddFrame("bartender/smokeblow7");
	smokeBlowAnim.AddFrame("bartender/smokeblow8");
	smokeBlowAnim.SetDurationInSeconds(1.0);
	var smokeBlowState = new AnimationState();
	smokeBlowState.SetMainAnimation(smokeBlowAnim);
	this.animationModel.AddState("smokeblow", smokeBlowState);
	
	var grabForearm = new Animation(this);
	grabForearm.inheritFacing = 1;
	grabForearm.AddBlankFrame();
	grabForearm.AddBlankFrame();
	grabForearm.AddBlankFrame();
	grabForearm.AddFrame("bartender/grab4_foreground");	
	grabForearm.AddFrame("bartender/grab5_foreground");	
	grabForearm.AddFrame("bartender/grab6_foreground");	
	grabForearm.AddFrame("bartender/grab7_foreground");	
	grabForearm.SetDurationInSeconds(0.5);
	
	var grabAnim = new Animation(this);
	grabAnim.inheritFacing = 1;					// It inherits the player's facing property
	grabAnim.AddFrame("bartender/grab1");					// All the frames and their timing info
	grabAnim.AddFrame("bartender/grab2");
	grabAnim.AddFrame("bartender/grab3");
	grabAnim.AddFrame("bartender/grab4");
	grabAnim.AddFrame("bartender/grab5");
	grabAnim.AddFrame("bartender/grab6");
	grabAnim.AddFrame("bartender/grab7");
	grabAnim.SetDurationInSeconds(0.5);
	var grabAnimState = new AnimationState();
	grabAnimState.SetMainAnimation(grabAnim);
	grabAnimState.AddDecoratorAnimation(grabForearm);
	this.animationModel.AddState("grab", grabAnimState);
	
	var grabfailAnim = new Animation(this);
	grabfailAnim.inheritFacing = 1;					// It inherits the player's facing property
	grabfailAnim.AddFrame("bartender/grabfail1");					// All the frames and their timing info
	grabfailAnim.AddFrame("bartender/grabfail2");
	grabfailAnim.AddFrame("bartender/grabfail3");
	grabfailAnim.AddFrame("bartender/grabfail4");
	grabfailAnim.AddFrame("bartender/grabfail5");
	grabfailAnim.SetDurationInSeconds(0.4);
	var grabfailAnimState = new AnimationState();
	grabfailAnimState.SetMainAnimation(grabfailAnim);
	this.animationModel.AddState("grabfail", grabfailAnimState);
	
	var releaseAnim = new Animation(this);
	releaseAnim.inheritFacing = 1;					// It inherits the player's facing property
	releaseAnim.AddFrame("bartender/grab3");					// All the frames and their timing info
	releaseAnim.AddFrame("bartender/grab2");
	releaseAnim.AddFrame("bartender/grab1");
	releaseAnim.SetDurationInSeconds(0.25);
	var releaseAnimState = new AnimationState();
	releaseAnimState.SetMainAnimation(releaseAnim);
	this.animationModel.AddState("release", releaseAnimState);
	
	var dragUpperBody = new Animation(this);
	dragUpperBody.inheritFacing = 1;	
	dragUpperBody.AddFrame("bartender/drag_layer2");	
	
	var dragForearm = new Animation(this);
	dragForearm.inheritFacing = 1;	
	dragForearm.AddFrame("bartender/drag_layer3");	
	
	var dragAnim = new Animation(this);
	dragAnim.repeat = 1;						// This animation loops
	dragAnim.dynamicRate = 1;					// This animation moves faster with player speed
	dragAnim.inheritFacing = 1;					// It inherits the player's facing property flipped
	dragAnim.AddFrame("bartender/drag1", 0,0);					// All the frames and their timing info
	dragAnim.AddFrame("bartender/drag2", 1,-1);
	dragAnim.AddFrame("bartender/drag3", 3,1);
	dragAnim.AddFrame("bartender/drag4", 2,2);
	dragAnim.AddFrame("bartender/drag5", 2,-1);
	dragAnim.AddFrame("bartender/drag6", 1,-2);
	dragAnim.AddFrame("bartender/drag7", 0,-2);
	dragAnim.AddFrame("bartender/drag8", 0,-1);
	dragAnim.SetDurationInSeconds(6.4);
	var dragAnimState = new AnimationState();
	dragAnimState.SetMainAnimation(dragAnim);
	dragAnimState.AddDecoratorAnimation(dragUpperBody);
	dragAnimState.AddDecoratorAnimation(dragForearm);
	this.animationModel.AddState("drag", dragAnimState);
	
	var dragIdleForearm = new Animation(this);
	dragIdleForearm.inheritFacing = 1;
	dragIdleForearm.AddFrame("bartender/grab7_foreground");	
	dragIdleForearm.SetDurationInSeconds(0.5);
	
	var dragIdleAnim = new Animation(this);
	dragIdleAnim.inheritFacing = 1;					// It inherits the player's facing property
	dragIdleAnim.AddFrame("bartender/grab7");
	dragIdleAnim.SetDurationInSeconds(0.5);
	var dragIdleAnimState = new AnimationState();
	dragIdleAnimState.SetMainAnimation(dragIdleAnim);
	dragIdleAnimState.AddDecoratorAnimation(dragIdleForearm);
	this.animationModel.AddState("dragIdle", dragIdleAnimState);
	
	var throwForearm = new Animation(this);
	throwForearm.inheritFacing = 1;	
	throwForearm.AddFrame("bartender/throw1_foreground");	
	throwForearm.AddBlankFrame();
	throwForearm.AddBlankFrame();
	throwForearm.AddBlankFrame();
	throwForearm.AddBlankFrame();
	throwForearm.AddBlankFrame();
	throwForearm.AddBlankFrame();
	throwForearm.SetDurationInSeconds(1.0);
	
	var throwAnim = new Animation(this);
	throwAnim.inheritFacing = 1;					// It inherits the player's facing property
	throwAnim.AddFrame("bartender/throw1");					// All the frames and their timing info
	throwAnim.AddFrame("bartender/throw2");
	throwAnim.AddFrame("bartender/throw3");
	throwAnim.AddFrame("bartender/throw4");
	throwAnim.AddFrame("bartender/throw5");
	throwAnim.AddFrame("bartender/throw6");
	throwAnim.AddFrame("bartender/throw7");
	throwAnim.SetDurationInSeconds(1.0);
	var throwAnimState = new AnimationState();
	throwAnimState.SetMainAnimation(throwAnim);
	throwAnimState.AddDecoratorAnimation(throwForearm);
	this.animationModel.AddState("throw", throwAnimState);
	
	// Define the captive animation
	var captiveAnim = new Animation(this);
	captiveAnim.repeat = 0;							// This animation is one-shot
	captiveAnim.inheritFacing = 1;					// It inherits the player's facing property
	captiveAnim.matchPosition = false;
	captiveAnim.AddFrame("bartender/knockout1");		// All the frames and their timing info
	captiveAnim.SetDurationInSeconds(0.4);
	var captiveState = new AnimationState();
	captiveState.SetMainAnimation(captiveAnim);
	this.animationModel.AddState("captive",captiveState);
	
	var captivepunchAnim = new Animation(this);
	captivepunchAnim.inheritFacing = 1;					// It inherits the player's facing property
	captivepunchAnim.AddFrame("bartender/captivepunch1",7,-2);
	captivepunchAnim.AddFrame("bartender/captivepunch2",21,-3);
	captivepunchAnim.AddFrame("bartender/captivepunch3",29,1);
	captivepunchAnim.AddFrame("bartender/captivepunch4",30,1);
	captivepunchAnim.AddFrame("bartender/captivepunch5",22,0);
	captivepunchAnim.AddFrame("bartender/captivepunch6",22,0);
	captivepunchAnim.AddFrame("bartender/captivepunch2",21,-3);
	captivepunchAnim.AddFrame("bartender/captivepunch3",29,1);
	captivepunchAnim.AddFrame("bartender/captivepunch4",30,1);
	captivepunchAnim.AddFrame("bartender/captivepunch5",22,0);
	captivepunchAnim.AddFrame("bartender/captivepunch6",22,0);
	captivepunchAnim.AddFrame("bartender/captivepunch2",21,-3);
	captivepunchAnim.AddFrame("bartender/captivepunch3",29,1);
	captivepunchAnim.AddFrame("bartender/captivepunch4",30,1);
	captivepunchAnim.AddFrame("bartender/captivepunch5",22,0);
	captivepunchAnim.AddFrame("bartender/captivepunch6",22,0);
	captivepunchAnim.AddFrame("bartender/captivepunch2",21,-3);
	captivepunchAnim.AddFrame("bartender/captivepunch3",29,1);
	captivepunchAnim.AddFrame("bartender/captivepunch4",30,1);
	captivepunchAnim.AddFrame("bartender/captivefinish1",22,0);
	captivepunchAnim.AddFrame("bartender/captivefinish2");
	captivepunchAnim.AddFrame("bartender/captivefinish3");
	captivepunchAnim.AddFrame("bartender/captivefinish4");
	captivepunchAnim.AddFrame("bartender/captivefinish5");
	captivepunchAnim.AddFrame("bartender/captivefinish6");
	captivepunchAnim.SetDurationInSeconds(2.2);
	var captivepunchAnimState = new AnimationState();
	captivepunchAnimState.SetMainAnimation(captivepunchAnim);
	this.animationModel.AddState("captivepunch", captivepunchAnimState);
	
	var captiveKissAnim = new Animation(this);
	captiveKissAnim.inheritFacing = 1;					// It inherits the player's facing property
	captiveKissAnim.AddFrame("bartender/smokekissjoe1");
	captiveKissAnim.AddFrame("bartender/smokekissjoe2",-2,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe3",-1,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe4",-3,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe5",-3,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe6",-3,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe5",-3,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe4",-3,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe7",-3,0);
	captiveKissAnim.AddFrame("bartender/smokekissjoe8",-10,-2);
	captiveKissAnim.AddFrame("bartender/smokekissjoe9",-16,-1);		// Kiss starts
	captiveKissAnim.AddFrame("bartender/smokekissjoe10",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe11",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe12",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe13",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe14",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe10",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe11",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe12",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe13",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe14",-16,-1);
	captiveKissAnim.AddFrame("bartender/smokekissjoe15",5,11);
	captiveKissAnim.AddFrame("bartender/smokekissjoe16",38,3);
	captiveKissAnim.AddFrame("bartender/smokekissjoe17");
	captiveKissAnim.SetDurationInSeconds(3);
	
	var captiveKissHeadAnim = new Animation(this);
	captiveKissHeadAnim.inheritFacing = 1;
	captiveKissHeadAnim.useDecoratorOffset = false;
	captiveKissHeadAnim.AddBlankFrames(10);
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe9_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe10_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe11_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe12_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe13_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe14_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe10_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe11_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe12_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe13_decorator");
	captiveKissHeadAnim.AddFrame("bartender/smokekissjoe14_decorator");
	captiveKissHeadAnim.AddBlankFrames(3);
	captiveKissHeadAnim.SetDurationInSeconds(3);
	
	var captiveKissAnimState = new AnimationState();
	captiveKissAnimState.SetMainAnimation(captiveKissAnim);
	captiveKissAnimState.AddDecoratorAnimation(captiveKissHeadAnim);
	this.animationModel.AddState("smokekissjoe", captiveKissAnimState);
	
	// Define the dash animation
	var dashAnim = new Animation(this);
	dashAnim.repeat = 0;							// This animation is one-shot
	dashAnim.inheritFacing = 1;					// It inherits the player's facing property
	dashAnim.matchPosition = false;
	dashAnim.AddFrame("bartender/dash1");		// All the frames and their timing info
	dashAnim.AddFrame("bartender/dash2");
	dashAnim.AddFrame("bartender/dash3");
	
	dashAnim.SetPosition(0,  0 / 15);
	dashAnim.SetPosition(1,  3 / 15);
	dashAnim.SetPosition(2,  12 / 15);
	
	dashAnim.SetDurationInSeconds(0.40);
	var dashState = new AnimationState();
	dashState.SetMainAnimation(dashAnim);
	this.animationModel.AddState("dash",dashState);
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe1sex/beforesex{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe1",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe1sex/beforesex{0}",5,7);
	beforeAnim.SetDurationInSeconds(0.3);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe1",beforeState);
	
	var footjobAnim = new Animation(this);
	footjobAnim.repeat = 0;							// This animation is one-shot
	footjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	footjobAnim.AddSequentialFrames("bartender/joe1sex/sex{0}",1,7);
	for (var i=0; i < footjobStrokes; i++)
	{
		footjobAnim.AddFrame("bartender/joe1sex/sex8");
		footjobAnim.AddFrame("bartender/joe1sex/sex9");
		footjobAnim.AddFrame("bartender/joe1sex/sex10");
		footjobAnim.AddFrame("bartender/joe1sex/sex11");
		footjobAnim.AddFrame("bartender/joe1sex/sex10");
		footjobAnim.AddFrame("bartender/joe1sex/sex9");
	}
	footjobAnim.AddSequentialFrames("bartender/joe1sex/sex{0}",8,24);
	footjobAnim.SetDurationInSeconds(footjobanimationduration);
	
	var footjobState = new AnimationState();
	footjobState.SetMainAnimation(footjobAnim);
	this.animationModel.AddState("sex/joe1",footjobState);
	
	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe1sex/aftersex{0}",1,6);
	afterAnim.SetDurationInSeconds(0.6);
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe1",afterState);
	
	
	
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe1sex2/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe1anal",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe1sex2/before{0}",1,4);
	beforeAnim.SetDurationInSeconds(0.4);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe1anal",beforeState);
	
	var analAnim = new Animation(this);
	analAnim.repeat = 0;							// This animation is one-shot
	analAnim.inheritFacing = 1;					// It inherits the player's facing property
	analAnim.AddSequentialFrames("bartender/joe1sex2/sex{0}",1,2);
	for (var i=0; i < footjobStrokes * 1.5; i++)
	{
		analAnim.AddFrame("bartender/joe1sex2/sex3");
		analAnim.AddFrame("bartender/joe1sex2/sex4");
		analAnim.AddFrame("bartender/joe1sex2/sex5");
		analAnim.AddFrame("bartender/joe1sex2/sex6");
	}
	analAnim.AddFrame("bartender/joe1sex2/sex3");
	analAnim.AddSequentialFrames("bartender/joe1sex2/sex{0}",7,13);
	analAnim.SetDurationInSeconds(footjobanimationduration);
	
	var analState = new AnimationState();
	analState.SetMainAnimation(analAnim);
	this.animationModel.AddState("sex/joe1anal",analState);
	
	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe1sex2/after{0}",1,5);
	afterAnim.SetDurationInSeconds(0.6);
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe1anal",afterState);
	
	
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddFrame("bartender/joe1drunksex/prepare1");
	prepareAnim.SetDurationInSeconds(0.1);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe1drunk",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe1drunksex/before{0}",1,3);
	beforeAnim.SetDurationInSeconds(0.8);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe1drunk",beforeState);
	
	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe1drunksex/sex{0}",1,10);
	for (var i=0; i < footjobStrokes; i++)
	{
		blowjobAnim.AddSequentialFrames("bartender/joe1drunksex/sex{0}",11,14);
	}
	blowjobAnim.AddSequentialFrames("bartender/joe1drunksex/sex{0}",15,24);
	blowjobAnim.SetDurationInSeconds(footjobanimationduration);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe1drunk",blowjobState);

	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddFrame("bartender/drunk/idle1");
	afterAnim.SetDurationInSeconds(0.6);
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe1drunk",afterState);
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe2drunksex/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe2drunk",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe2drunksex/before{0}",1,3);
	beforeAnim.SetDurationInSeconds(0.4);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe2drunk",beforeState);
	
	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe2drunksex/sex{0}",1,45);
	blowjobAnim.SetDurationInSeconds(8.0);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe2drunk",blowjobState);

	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe2drunksex/after{0}",1,12);
	afterAnim.SetDurationInSeconds(2.2);
	afterAnim.SetDurationInSecondsWithoutRetime(3.1)
	afterAnim.AddSequentialTimedFrames("bartender/joe2drunksex/after{0}",13,20,2.3,0.1);
	
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe2drunk",afterState);
	
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe3drunksex/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe3drunk",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe3drunksex/before{0}",1,4);
	beforeAnim.SetDurationInSeconds(0.4);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe3drunk",beforeState);
	
	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe3drunksex/sex{0}",1,5);
	for (var i=0; i < drunkAnalThrusts; i++)
	{
		blowjobAnim.AddSequentialFrames("bartender/joe3drunksex/loop{0}",1,4);
	}
	blowjobAnim.AddSequentialFrames("bartender/joe3drunksex/sex{0}",6,18);
	blowjobAnim.SetDurationInSeconds((1.8 + 0.4 * drunkAnalThrusts)*1.8);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe3drunk",blowjobState);

	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe3drunksex/after{0}",1,6);
	afterAnim.SetDurationInSeconds(0.6);
	
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe3drunk",afterState);
	
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe4drunksex/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe4drunk",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe4drunksex/before{0}",1,3);
	beforeAnim.SetDurationInSeconds(0.4);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe4drunk",beforeState);
	
	//var drunkKisses = 3;
	//var drunkCowboyThrusts = 6;
	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe4drunksex/sex{0}",1,8);
	for (var i=0; i < drunkKisses; i++)
	{
		blowjobAnim.AddSequentialFrames("bartender/joe4drunksex/kissing{0}",1,5);
	}
	blowjobAnim.AddSequentialFrames("bartender/joe4drunksex/sex{0}",9,19);
	for (var i=0; i < drunkCowboyThrusts; i++)
	{
		blowjobAnim.AddSequentialFrames("bartender/joe4drunksex/fuck{0}",1,4);
	}
	blowjobAnim.AddSequentialFrames("bartender/joe4drunksex/fuck{0}",1,2);
	blowjobAnim.AddSequentialFrames("bartender/joe4drunksex/sex{0}",20,32);
	blowjobAnim.SetDurationInSeconds((0.8 + 0.5 * drunkKisses + 1.0 + 0.4 * drunkCowboyThrusts + 1.4)*1.8);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe4drunk",blowjobState);

	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddFrame("bartender/joe4drunksex/after1");
	afterAnim.AddSequentialFrames("bartender/joe4drunksex/after{0}",1,9);
	afterAnim.SetDurationInSeconds(1.8);
	
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe4drunk",afterState);
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe2sex/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe2",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe2sex/before{0}",1,3);
	beforeAnim.SetDurationInSeconds(0.3);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe2",beforeState);
	
	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe2sex/after{0}",1,5);
	afterAnim.SetDurationInSeconds(0.5);
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe2",afterState);

	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe2sex/sex{0}",1,3);
	for (var i=0; i < blowjobStrokes; i++)
	{
		blowjobAnim.AddFrame("bartender/joe2sex/sex4");
		blowjobAnim.AddFrame("bartender/joe2sex/sex5");
		blowjobAnim.AddFrame("bartender/joe2sex/sex6");
		blowjobAnim.AddFrame("bartender/joe2sex/sex5");
	}
	blowjobAnim.AddSequentialFrames("bartender/joe2sex/sex{0}",4,11);
	blowjobAnim.SetDurationInSeconds(blowjobanimationduration);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe2",blowjobState);
	
	
	
	
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe3sex/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe3",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe3sex/before{0}",1,4);
	beforeAnim.SetDurationInSeconds(0.4);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe3",beforeState);
	
	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe3sex/after{0}",1,4);
	afterAnim.SetDurationInSeconds(0.5);
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe3",afterState);

	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe3sex/sex{0}",1,2);
	for (var i=0; i < thrusts; i++)
	{
		blowjobAnim.AddSequentialFrames("bartender/joe3sex/sex{0}",3,7);
	}
	blowjobAnim.AddSequentialFrames("bartender/joe3sex/sex{0}",3,4);
	blowjobAnim.AddSequentialFrames("bartender/joe3sex/sex{0}",8,14);
	blowjobAnim.SetDurationInSeconds(sexanimationduration);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe3",blowjobState);
	
	
	
	
	var prepareAnim = new Animation(this);
	prepareAnim.repeat = 0;							// This animation is one-shot
	prepareAnim.inheritFacing = 1;					// It inherits the player's facing property
	prepareAnim.AddSequentialFrames("bartender/joe4sex/prepare{0}",1,4);
	prepareAnim.SetDurationInSeconds(0.4);
	var prepareState = new AnimationState();
	prepareState.SetMainAnimation(prepareAnim);
	this.animationModel.AddState("preparesex/joe4",prepareState);
	
	var beforeAnim = new Animation(this);
	beforeAnim.repeat = 0;							// This animation is one-shot
	beforeAnim.inheritFacing = 1;					// It inherits the player's facing property
	beforeAnim.AddSequentialFrames("bartender/joe4sex/before{0}",1,3);
	beforeAnim.SetDurationInSeconds(0.3);
	var beforeState = new AnimationState();
	beforeState.SetMainAnimation(beforeAnim);
	this.animationModel.AddState("beforesex/joe4",beforeState);
	
	var afterAnim = new Animation(this);
	afterAnim.repeat = 0;							// This animation is one-shot
	afterAnim.inheritFacing = 1;					// It inherits the player's facing property
	afterAnim.AddSequentialFrames("bartender/joe4sex/after{0}",1,4);
	afterAnim.SetDurationInSeconds(0.5);
	var afterState = new AnimationState();
	afterState.SetMainAnimation(afterAnim);
	this.animationModel.AddState("aftersex/joe4",afterState);


	var blowjobAnim = new Animation(this);
	blowjobAnim.repeat = 0;							// This animation is one-shot
	blowjobAnim.inheritFacing = 1;					// It inherits the player's facing property
	blowjobAnim.AddSequentialFrames("bartender/joe4sex/sex{0}",1,11);
	for (var i=0; i < 3; i++) // 12 - 24
	{
		blowjobAnim.AddFrame("bartender/joe4sex/sex10");
		blowjobAnim.AddFrame("bartender/joe4sex/sex9");
		blowjobAnim.AddFrame("bartender/joe4sex/sex10");
		blowjobAnim.AddFrame("bartender/joe4sex/sex11");
	}
	blowjobAnim.AddFrame("bartender/joe4sex/sex10");
	
	blowjobAnim.AddSequentialFrames("bartender/joe4sex/sex{0}",25,32);
	for (var i=0; i < thrusts; i++)
	{
		blowjobAnim.AddSequentialFrames("bartender/joe4sex/loop{0}",1,5);
	}
	blowjobAnim.SetDurationInSeconds(spitroastanimationduration);
	
	var blowjobState = new AnimationState();
	blowjobState.SetMainAnimation(blowjobAnim);
	this.animationModel.AddState("sex/joe4",blowjobState);
	
	this.smokeCloneAnimation = new Animation(this);
	this.smokeCloneAnimation.repeat = 0;							// This animation is one-shot
	this.smokeCloneAnimation.inheritFacing = 1;					// It inherits the player's facing property
	this.smokeCloneAnimation.AddBlankFrames(2);
	this.smokeCloneAnimation.AddSequentialFrames("bartender/joe4sex/smoke{0}",3,32);
	for (var i=0; i < thrusts; i++)
	{
		this.smokeCloneAnimation.AddSequentialFrames("bartender/joe4sex/smokeloop{0}",1,5);
	}
	this.smokeCloneAnimation.blendMode = "lighter";
	this.smokeCloneAnimation.SetDurationInSeconds(spitroastanimationduration  + 1/60);

	this.smokeCloneAfterAnimation = new Animation(this);
	this.smokeCloneAfterAnimation.repeat = 0;							// This animation is one-shot
	this.smokeCloneAfterAnimation.inheritFacing = 1;					// It inherits the player's facing property
	this.smokeCloneAfterAnimation.AddSequentialFrames("bartender/joe4sex/smokeafter{0}",1,8);
	this.smokeCloneAfterAnimation.SetDurationInSeconds(0.8);
	this.smokeCloneAfterAnimation.blendMode = "lighter";
	
	
	// Define the desperation attack animation
	var desperationAnim = new Animation(this);
	desperationAnim.repeat = 0;						// This animation bounces
	desperationAnim.inheritFacing = 1;
	desperationAnim.AddSequentialFrames("bartender/desperationattack{0}",1,15);		// All the frames and their timing info
	desperationAnim.HoldFrame("bartender/desperationattack15",11);
	desperationAnim.AddFrame("bartender/desperationattack16");
	desperationAnim.SetDurationInSeconds(1.7);
	var desperationState = new AnimationState();
	desperationState.SetMainAnimation(desperationAnim);
	this.animationModel.AddState("desperation", desperationState);
	
	this.desperationSmokeAnim = new Animation(this);
	this.desperationSmokeAnim.AddSequentialFrames("bartender/desperationsmoke{0}",1,19);	
	this.desperationSmokeAnim.blendMode = "lighter";
	this.desperationSmokeAnim.inheritFacing = 0;		
	this.desperationSmokeAnim.SetDurationInSeconds(2.0);

	// Define the desperation attack animation
	var quicksmokeAnim = new Animation(this);
	quicksmokeAnim.repeat = 0;						// This animation bounces
	quicksmokeAnim.inheritFacing = 1;
	quicksmokeAnim.AddSequentialFrames("bartender/quicksmoke{0}",1,7);		// All the frames and their timing info
	quicksmokeAnim.AddSequentialFrames("bartender/smokeblow{0}",7,8);		// All the frames and their timing info
	quicksmokeAnim.SetDurationInSeconds(0.8);
	var quicksmokeState = new AnimationState();
	quicksmokeState.SetMainAnimation(quicksmokeAnim);
	this.animationModel.AddState("quicksmoke", quicksmokeState);
	
	this.quicksmokeSmokeAnim = new Animation(this);
	this.quicksmokeSmokeAnim.AddSequentialFrames("bartender/quicksmoke_smoke{0}",1,9);	
	this.quicksmokeSmokeAnim.blendMode = "lighter";
	this.quicksmokeSmokeAnim.inheritFacing = 1;
	this.quicksmokeSmokeAnim.SetDurationInSeconds(1.0);
	
	
	// Drunk animations
	// Define the idle animation
	var idleAnim = new Animation(this);
	idleAnim.repeat = 1;						// This animation loops
	idleAnim.inheritFacing = 1;					// It inherits the player's facing property
	idleAnim.sendPosition = false;
	idleAnim.AddSequentialFrames("bartender/drunk/idle{0}",1,18);		// All the frames and their timing info
	idleAnim.SetDurationInSeconds(2.0);				// Set how long one loop takes (in seconds)
	
	// Add the idle animation and all its transitions to the idle animation state
	var idleState = new AnimationState();
	idleState.SetMainAnimation(idleAnim);
	
	idleState.AddTransitionAnimation("snarehitstun", hitStunAnim); 
	
	// Define a transition from walk to idle
	var walkToIdle = new Animation(this);
	walkToIdle.repeat = 3;
	walkToIdle.inheritFacing = 1;					// It inherits the player's facing property
	walkToIdle.matchPosition = true;
	walkToIdle.AddFrame("bartender/drunk/walk1");
	walkToIdle.SetDurationInSeconds(0.2);
	idleState.AddTransitionAnimation("drunkwalk", walkToIdle); 
	
	// Add all the animation states to the animations collection
	this.animationModel.AddState("drunkidle",idleState);
	
	// Define the walk animation
	var walkAnim = new Animation(this);
	walkAnim.repeat = 1;						// This animation loops
	walkAnim.dynamicRate = 1;					// This animation moves faster with player speed
	walkAnim.inheritFacing = 1;					// It inherits the player's facing property
	walkAnim.matchPosition = true;
	walkAnim.AddSequentialFrames("bartender/drunk/walk{0}",1,9);		// All the frames and their timing info
	walkAnim.SetDurationInSeconds(6.4);
	var walkState = new AnimationState();
	walkState.SetMainAnimation(walkAnim);
	this.animationModel.AddState("drunkwalk", walkState);
	
	// Define the walk animation
	var runAnim = new Animation(this);
	runAnim.repeat = 0;							// This animation does not loop
	runAnim.dynamicRate = 1;					// This animation moves faster with player speed
	runAnim.inheritFacing = 1;					// It inherits the player's facing property
	runAnim.matchPosition = true;
	runAnim.AddSequentialFrames("bartender/drunk/run{0}",1,4);		// All the frames and their timing info
	runAnim.SetDurationInSeconds(7.6);
	var runState = new AnimationState();
	runState.SetMainAnimation(runAnim);
	this.animationModel.AddState("drunkrun",runState);
	
	var runAnim = new Animation(this);
	runAnim.repeat = 0;							// This animation does not loop
	runAnim.dynamicRate = 0;					// This animation plays at a set speed
	runAnim.inheritFacing = 1;					// It inherits the player's facing property
	runAnim.matchPosition = true;
	runAnim.AddSequentialFrames("bartender/drunk/run{0}",5,15);		// All the frames and their timing info
	runAnim.SetDurationInSeconds(1.2);
	var runState = new AnimationState();
	runState.SetMainAnimation(runAnim);
	this.animationModel.AddState("drunkrunfall",runState);
	
	// Define the smoke-walk animation
	var smokeAttackAnim = new Animation(this);
	smokeAttackAnim.repeat = 2;						// This animation bounces
	smokeAttackAnim.inheritFacing = 1;
	smokeAttackAnim.AddFrame("bartender/drunk/smokecharge1");		// All the frames and their timing info
	smokeAttackAnim.AddFrame("bartender/drunk/smokecharge2");
	smokeAttackAnim.AddFrame("bartender/drunk/smokecharge3");
	smokeAttackAnim.AddFrame("bartender/drunk/smokecharge4");
	smokeAttackAnim.AddFrame("bartender/drunk/smokecharge5");
	smokeAttackAnim.AddFrame("bartender/drunk/smokecharge6");
	smokeAttackAnim.SetDurationInSeconds(0.8);
	smokeAttackAnim.loopStartPosition = (2.0/6.0);	// When bouncing, bounce between 3 and 6
	
	var smokeWalkAnim = new Animation(this);
	smokeWalkAnim.repeat = 1;						// This animation loops
	smokeWalkAnim.dynamicRate = 1;					// This animation moves faster with player speed
	smokeWalkAnim.inheritFacing = 1;					// It inherits the player's facing property
	smokeWalkAnim.matchPosition = true;
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk1",0,0);					// All the frames and their timing info
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk2",6,2);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk3",11,3);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk4",9,4);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk5",11,3);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk6",9,2);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk7",11,-1);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk8",4,-4);
	smokeWalkAnim.AddFrame("bartender/drunk/smokewalk9",2,-1);
	smokeWalkAnim.SetDurationInSeconds(6.4);
	var smokeWalkState = new AnimationState();
	smokeWalkState.SetMainAnimation(smokeWalkAnim);
	smokeWalkState.AddDecoratorAnimation(smokeAttackAnim);
	this.animationModel.AddState("drunksmokewalk", smokeWalkState);
	
	var smokeIdleAnim = new Animation(this);
	smokeIdleAnim.repeat = 1;						// This animation loops
	smokeIdleAnim.dynamicRate = 0;					// This animation moves faster with player speed
	smokeIdleAnim.inheritFacing = 1;					// It inherits the player's facing property
	smokeIdleAnim.matchPosition = false;
	smokeIdleAnim.sendPosition = false;

	smokeIdleAnim.AddSequentialFrames("bartender/drunk/smokeidle{0}",1,5);
	smokeIdleAnim.AddSequentialFrames("bartender/drunk/smokeidle{0}",4,1);
	smokeIdleAnim.AddSequentialFrames("bartender/drunk/smokeidle{0}",6,9);
	smokeIdleAnim.AddSequentialFrames("bartender/drunk/smokeidle{0}",8,6);
	smokeIdleAnim.SetDecoratorOffset( 0,  0,0);	// 1
	smokeIdleAnim.SetDecoratorOffset( 1, -6,0);	// 2
	smokeIdleAnim.SetDecoratorOffset( 2, -9,0);	// 3
	smokeIdleAnim.SetDecoratorOffset( 3,-10,0);	// 4
	smokeIdleAnim.SetDecoratorOffset( 4,-11,0);	// 5
	smokeIdleAnim.SetDecoratorOffset( 5,-10,0);	// 4
	smokeIdleAnim.SetDecoratorOffset( 6, -9,0);	// 3
	smokeIdleAnim.SetDecoratorOffset( 7, -6,0);	// 2
	smokeIdleAnim.SetDecoratorOffset( 8,  0,0);	// 1
	smokeIdleAnim.SetDecoratorOffset( 9,  4,0);	// 6
	smokeIdleAnim.SetDecoratorOffset(10,  8,0);	// 7
	smokeIdleAnim.SetDecoratorOffset(11, 10,0);	// 8
	smokeIdleAnim.SetDecoratorOffset(12, 12,0);	// 9
	smokeIdleAnim.SetDecoratorOffset(13, 10,0);	// 8
	smokeIdleAnim.SetDecoratorOffset(14,  8,0);	// 7
	smokeIdleAnim.SetDecoratorOffset(15,  4,0);	// 6
	
	smokeIdleAnim.SetDurationInSeconds(2.5);
	var smokeIdleState = new AnimationState();
	smokeIdleState.SetMainAnimation(smokeIdleAnim);
	smokeIdleState.AddDecoratorAnimation(smokeAttackAnim);
	this.animationModel.AddState("drunksmokeidle", smokeIdleState);
	
	
		// Define the smoke-walk animation
	var smokeChargeFastAnim = new Animation(this);
	smokeChargeFastAnim.repeat = 0;						// This animation bounces
	smokeChargeFastAnim.inheritFacing = 1;
	// All the frames and their timing info
	smokeChargeFastAnim.AddSequentialFrames("bartender/drunk/smokecharge{0}", 2, 6);
	smokeChargeFastAnim.SetDurationInSeconds(0.333);
	
		// Define the smoke-smoking idle cancel animation
	var smokeAttackCancelAnim = new Animation(this);
	smokeAttackCancelAnim.repeat = 0;						// This animation bounces
	smokeAttackCancelAnim.inheritFacing = 1;
	smokeAttackCancelAnim.AddFrame("bartender/drunk/smokecharge3");		// All the frames and their timing info
	smokeAttackCancelAnim.AddFrame("bartender/drunk/smokecharge2");
	smokeAttackCancelAnim.AddFrame("bartender/drunk/smokecharge1");
	smokeAttackCancelAnim.SetDurationInSeconds(0.26);
	
	var smokeIdleCancelState = new AnimationState();
	smokeIdleCancelState.SetMainAnimation(smokeIdleAnim);
	smokeIdleCancelState.AddDecoratorAnimation(smokeAttackCancelAnim);
	this.animationModel.AddState("drunksmokeidlecancel", smokeIdleCancelState);
	
	var smokeWalkCancelState = new AnimationState();
	smokeWalkCancelState.SetMainAnimation(smokeWalkAnim);
	smokeWalkCancelState.AddDecoratorAnimation(smokeAttackCancelAnim);
	this.animationModel.AddState("drunksmokewalkcancel", smokeWalkCancelState);
	
	
	
	//var dragAnimState = new AnimationState();
	//dragAnimState.SetMainAnimation(smokeWalkAnim);
	//dragAnimState.AddDecoratorAnimation(dragUpperBody);
	//dragAnimState.AddDecoratorAnimation(dragForearm);
	this.animationModel.AddState("drunkdrag", dragAnimState);
	

	//var dragIdleAnimState = new AnimationState();
	//dragIdleAnimState.SetMainAnimation(smokeIdleAnim);
	//dragIdleAnimState.AddDecoratorAnimation(dragIdleForearm);
	this.animationModel.AddState("drunkdragIdle", dragIdleAnimState);
	
	
	
	var finishbossAnim = new Animation(this);
	finishbossAnim.repeat = 0;							// This animation is one-shot
	finishbossAnim.inheritFacing = 1;					// It inherits the player's facing property
	finishbossAnim.HoldFrame("bartender/joe5sex/kiss1",2);
	finishbossAnim.AddSequentialFrames("bartender/joe5sex/kiss{0}",1,27);
	finishbossAnim.SetDurationInSeconds(4.6);
	var finishbossState = new AnimationState();
	finishbossState.SetMainAnimation(finishbossAnim);
	this.animationModel.AddState("finishboss",finishbossState);
	
	// Define the idle animation
	var idleAnim = new Animation(this);
	idleAnim.repeat = 1;						// This animation loops
	idleAnim.inheritFacing = 1;					// It inherits the player's facing property
	idleAnim.sendPosition = false;
	idleAnim.AddFrame("bartender/joe5sex/idle");		// All the frames and their timing info
	idleAnim.SetDurationInSeconds(1.0);				// Set how long one loop takes (in seconds)
	
	// Add the idle animation and all its transitions to the idle animation state
	var idleState = new AnimationState();
	idleState.SetMainAnimation(idleAnim);
	
	// Define a transition from walk to idle
	var walkToIdle = new Animation(this);
	walkToIdle.repeat = 3;
	walkToIdle.inheritFacing = 1;					// It inherits the player's facing property
	walkToIdle.matchPosition = true;
	walkToIdle.AddFrame("bartender/joe5sex/before1");
	walkToIdle.SetDurationInSeconds(0.2);
	idleState.AddTransitionAnimation("transformwalk", walkToIdle); 
	
	// Add all the animation states to the animations collection
	this.animationModel.AddState("transformidle",idleState);
	
	// Define the walk animation
	var walkAnim = new Animation(this);
	walkAnim.repeat = 1;						// This animation loops
	walkAnim.dynamicRate = 1;					// This animation moves faster with player speed
	walkAnim.inheritFacing = 1;					// It inherits the player's facing property
	walkAnim.matchPosition = true;
	walkAnim.AddSequentialFrames("bartender/joe5sex/before{0}",1,6);		// All the frames and their timing info
	walkAnim.SetDurationInSeconds(6.4);
	var walkState = new AnimationState();
	walkState.SetMainAnimation(walkAnim);
	this.animationModel.AddState("transformwalk", walkState);
	
	// Define the walk animation
	var transformAnim = new Animation(this);
	transformAnim.repeat = 0;						// This animation loops
	transformAnim.inheritFacing = 1;					// It inherits the player's facing property
	transformAnim.AddSequentialFrames("bartender/joe5sex/transform{0}",1,10);		// All the frames and their timing info
	transformAnim.SetDurationInSeconds(1.0);
	var transformState = new AnimationState();
	transformState.SetMainAnimation(transformAnim);
	this.animationModel.AddState("transforming", transformState);
	
	var anim = new Animation(this);
	anim.repeat = 0;
	anim.inheritFacing = 1;
	anim.AddFrame("bartender/joe5sex/before1");
	anim.SetDurationInSeconds(0.2);
	var animState = new AnimationState();
	animState.SetMainAnimation(anim);
	this.animationModel.AddState("preparesex/joe5",animState);
	
	var anim = new Animation(this);
	anim.repeat = 0;
	anim.inheritFacing = 1;
	anim.AddSequentialFrames("bartender/joe5sex/before{0}",1,6);
	anim.SetDurationInSeconds(0.6);
	var animState = new AnimationState();
	animState.SetMainAnimation(anim);
	this.animationModel.AddState("beforesex/joe5",animState);
	
	// Define the corrupt animation
	var anim = new Animation(this);
	anim.repeat = 0;
	anim.inheritFacing = 1;
	anim.sendPosition = false;
	
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 1, 17, 10);
	
	for (var i = 0; i < 6; i++)
		anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 18, 25, linearRemap(i,0,5,8,12));
		
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 26, 36, 10);
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 37, 41, 7);		// Slower
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 42, 54, 8);

	for (var i = 0; i < 8; i++)
		anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 55, 66, linearRemap(i,0,5,8,12));
	
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 67, 85, 10);
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 86, 91, 8);
	
	for (var i = 0; i < 12; i++)
		anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 92, 96, linearRemap(i,0,5,8,14));
		
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 97, 100, 10);
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 101, 108, 8);
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 109, 112, 8);
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 109, 112, 4);
	anim.AddSequentialFramesAtFramerate("bartender/joe5sex/sex{0}", 109, 112, 2);
	
	anim.NormalizeAnimationTiming();
	
	var animState = new AnimationState();
	animState.SetMainAnimation(anim);
	this.animationModel.AddState("sex/joe5",animState);
	
	
	var anim = new Animation(this);
	anim.repeat = 0;
	anim.inheritFacing = 1;
	anim.AddFrame("bartender/idle1");
	anim.SetDurationInSeconds(0.1);
	var animState = new AnimationState();
	animState.SetMainAnimation(anim);
	this.animationModel.AddState("preparesex/joe5precorrupt",animState);
	
	
	var anim = new Animation(this);
	anim.repeat = 0;
	anim.inheritFacing = 1;
	anim.AddSequentialFrames("bartender/walk{0}",1,4);
	anim.SetDurationInSeconds(0.4);
	var animState = new AnimationState();
	animState.SetMainAnimation(anim);
	this.animationModel.AddState("beforesex/joe5precorrupt",animState);
	
};

Bartender.prototype.GetGroundFriction = function()
{
	if (IsInvulnerable(this.state))
		return this.groundFrictionKO;
	else if (this.state === States.Grab || this.state === States.GrabFail)
		return this.groundFrictionKO;
	else
		return this.groundFriction;
};

Bartender.prototype.ChangeAlliance = function(newAlliance)
{
	this.alliance = newAlliance;
	//this.lightPunchAttack.alliance = newAlliance;
	//this.kickAttack.alliance = newAlliance;
	//this.tackleAttack.alliance = newAlliance;
	//this.weakTackleAttack.alliance = newAlliance;
	//this.quickSmokeAttack.alliance = newAlliance;
	//this.airKickAttack.alliance = newAlliance;
	//this.smokeKissAttack.alliance = newAlliance;
};

Bartender.prototype.NotifyDamageDealt = function(damageDealt, corruptionDealt)
{
	EntityNotifyDamageDealt.call(this, damageDealt, corruptionDealt);
	
	if (this.drunkTimer > 0)
		this.sexMeter += (damageDealt*8.0 + corruptionDealt*10.0);
	else
		this.sexMeter += (damageDealt*2.0 + corruptionDealt*4.0);
	if (this.sexMeter > this.maxSexMeter)
		this.sexMeter = this.maxSexMeter;
};

Bartender.prototype.Hit = function(attack, isCaptive)
{
	var canLoseLife = (this.health > 0);
	
	if (this.invincibilityFrames === 0 || attack.owner === this.captive)
	{
		if (this.state === States.SmokeKiss)
		{
			if (this.stateFrames < 60)
				EntityHit.call(this, attack, isCaptive);
		}
		else
		{
			EntityHit.call(this, attack, isCaptive);
		}
	}
	
	if (this.health === 0 && this === player && canLoseLife)
	{
		// Take away a life
		if (lives > 0 )
		{
			lives -= 1;
		}
		// If this was the last life, enable slowmo
		if (lives === 0)
			entityFrameskip = 2;
	}
}

// Boilerplate Entity Code
Bartender.prototype.Init = EntityInit;
Bartender.prototype.ChangeState = EntityChangeState;
Bartender.prototype.ChangeStateOnAttackComplete = EntityChangeStateOnAttackComplete;
Bartender.prototype.Speed = EntitySpeed;
Bartender.prototype.Kill = EntityKill;
Bartender.prototype.Die = EntityDie;
Bartender.prototype.CancelAttack = EntityCancelAttack;
//Bartender.prototype.Respawn = EntityRespawn;	// Overridden
//Bartender.prototype.GetGroundFriction = EntityGetGroundFriction;	// Overridden
//Bartender.prototype.DrawSprite = EntityDrawSprite;	// Overridden
Bartender.prototype.Draw = EntityDraw;
Bartender.prototype.ProcessDirectionalInput = EntityProcessDirectionalInput;
//Bartender.prototype.UpdateState = EntityUpdateState;	// Overridden
Bartender.prototype.Update = EntityUpdate;
Bartender.prototype.Push = EntityPush;
//Bartender.prototype.Hit = EntityHit;
Bartender.prototype.Capture = EntityCapture;
Bartender.prototype.Release = EntityRelease;
//Bartender.prototype.ChangeAlliance = EntityChangeAlliance;
//Bartender.prototype.NotifyDamageDealt = EntityNotifyDamageDealt;
Bartender.prototype.CollisionDetection = EntityCollisionDetection;
Bartender.prototype.WatchSex = EntityWatchSex;
Bartender.prototype.DoneWatchingSex = EntityDoneWatchingSex;
Bartender.prototype.RequestAttackPermission = EntityRequestAttackPermission;
Bartender.prototype.ReleaseAttackPermission = EntityReleaseAttackPermission;
Bartender.prototype.OnRemovalFromGame = EntityOnRemovalFromGame;
Bartender.prototype.ReleaseOrbs = EntityReleaseOrbs;